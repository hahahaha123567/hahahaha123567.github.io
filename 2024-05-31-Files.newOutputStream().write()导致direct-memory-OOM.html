<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Files.newOutputStream()的优点如果你使用IDEA写代码的话, 当你写下new FileOutputStream(file)时, IDE会提示你修改为Files.newOutputStream(file.path), 具体的描述在Settings-Editor-Inspections-Java-Performance中  Reports new FileInputStream(">
<meta property="og:type" content="article">
<meta property="og:title" content="Files.newOutputStream().write()使用direct memory">
<meta property="og:url" content="https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html">
<meta property="og:site_name" content="hahahaha123567">
<meta property="og:description" content="Files.newOutputStream()的优点如果你使用IDEA写代码的话, 当你写下new FileOutputStream(file)时, IDE会提示你修改为Files.newOutputStream(file.path), 具体的描述在Settings-Editor-Inspections-Java-Performance中  Reports new FileInputStream(">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-05-31T04:00:00.000Z">
<meta property="article:modified_time" content="2024-06-03T11:01:37.226Z">
<meta property="article:author" content="hahahaha123567">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/image/avatar.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/image/avatar.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/image/avatar.jpg">
        
      
    
    <!-- title -->
    <title>Files.newOutputStream().write()使用direct memory</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="hahahaha123567" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/favorite/">star</a></li><!--
     --><!--
       --><li><a href="/link/">link</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2024-06-03-%E6%8E%92%E6%9F%A5Netty%E5%BA%94%E7%94%A8%E7%9A%84direct-memory%E6%B3%84%E6%BC%8F.html"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2024-03-26-%E3%80%8A%E7%8B%AC%E8%A3%81%E8%80%85%E6%89%8B%E5%86%8C%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&text=Files.newOutputStream().write()使用direct memory"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&title=Files.newOutputStream().write()使用direct memory"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&is_video=false&description=Files.newOutputStream().write()使用direct memory"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Files.newOutputStream().write()使用direct memory&body=Check out this article: https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&title=Files.newOutputStream().write()使用direct memory"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&title=Files.newOutputStream().write()使用direct memory"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&title=Files.newOutputStream().write()使用direct memory"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&title=Files.newOutputStream().write()使用direct memory"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&name=Files.newOutputStream().write()使用direct memory&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&t=Files.newOutputStream().write()使用direct memory"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Files-newOutputStream-%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">Files.newOutputStream()的优点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%BA%90%E7%A0%81"><span class="toc-number">1.1.</span> <span class="toc-text">查看源码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Direct-Memory"><span class="toc-number">2.</span> <span class="toc-text">Direct Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B"><span class="toc-number">2.2.</span> <span class="toc-text">查看</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Files.newOutputStream().write()使用direct memory
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">hahahaha123567</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-05-31T04:00:00.000Z" class="dt-published" itemprop="datePublished">2024-05-31</time>
        
        (Updated: <time datetime="2024-06-03T11:01:37.226Z" class="dt-updated" itemprop="dateModified">2024-06-03</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Java/" rel="tag">Java</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="Files-newOutputStream-的优点"><a href="#Files-newOutputStream-的优点" class="headerlink" title="Files.newOutputStream()的优点"></a>Files.newOutputStream()的优点</h1><p>如果你使用IDEA写代码的话, 当你写下<code>new FileOutputStream(file)</code>时, IDE会提示你修改为<code>Files.newOutputStream(file.path)</code>, 具体的描述在<code>Settings-Editor-Inspections-Java-Performance</code>中</p>
<blockquote>
<p>Reports new FileInputStream() or new FileOutputStream() expressions that can be replaced with Files.newInputStream() or Files.newOutputStream() calls respectively. The streams created using Files methods are usually more efficient than those created by stream constructors.</p>
</blockquote>
<p>那么, <code>usually more efficient</code>的点在哪里呢?</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/35509087/files-newoutputstream-vs-fileoutputstream">java - Files.newOutputStream vs FileOutputStream - Stack Overflow</a></p>
<ol>
<li>旧的方法有finalize(), 在GC后、finalize()调用前, 对象会处于未回收状态</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/55370117/is-java-nio-file-files-newinputstreammyfile-topath-better-than-new-fileinput">Is java.nio.file.Files.newInputStream(myfile.toPath()) better than new FileInputStream(file)? - Stack Overflow</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cloudbees.com/blog/fileinputstream-fileoutputstream-considered-harmful">FileInputStream &#x2F; FileOutputStream Considered Harmful</a></p>
<ol start="2">
<li>windows系统下, 新方法打开文件会添加<code>FILE_SHARE_DELETE</code>选项</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/logging-log4j2/issues/2117">Consider replacing <code>FileOutputStream</code> with <code>Files.newOutputStream</code> · Issue #2117 · apache&#x2F;logging-log4j2</a></p>
<h2 id="查看源码"><a href="#查看源码" class="headerlink" title="查看源码"></a>查看源码</h2><p>以下均基于Java8, 省略读写选项等逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Files</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> OutputStream <span class="title function_">newOutputStream</span><span class="params">(Path path, OpenOption... options)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">return</span> provider(path).newOutputStream(path, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不同平台会提供不同的<code>FileSystemProvider</code>, MacOS是<code>MacOSXFileSystemProvider</code>, Linux是<code>LinuxFileSystemProvider</code>, 对于<code>newOutputStream</code>方法均没有单独的实现, 生效的是<code>FileSystemProvider#newOutputStream</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileSystemProvider</span></span><br><span class="line"><span class="keyword">public</span> OutputStream <span class="title function_">newOutputStream</span><span class="params">(Path path, OpenOption... options)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">return</span> Channels.newOutputStream(newByteChannel(path, opts));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>newByteChannel</code>的实现是<code>UnixFileSystemProvider#newByteChannel</code>, 最终返回一个<code>FileChannelImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnixFileSystemProvider</span></span><br><span class="line"><span class="keyword">public</span> SeekableByteChannel <span class="title function_">newByteChannel</span><span class="params">(Path obj, Set&lt;? extends OpenOption&gt; options, FileAttribute&lt;?&gt;... attrs)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">UnixPath</span> <span class="variable">file</span> <span class="operator">=</span> UnixPath.toUnixPath(obj);</span><br><span class="line">    <span class="keyword">return</span> UnixChannelFactory.newFileChannel(file, options, mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnixChannelFactory</span></span><br><span class="line"><span class="keyword">static</span> FileChannel <span class="title function_">newFileChannel</span><span class="params">(UnixPath path, Set&lt;? extends OpenOption&gt; options, <span class="type">int</span> mode)</span> <span class="keyword">throws</span> UnixException &#123;</span><br><span class="line">    <span class="keyword">return</span> newFileChannel(-<span class="number">1</span>, path, <span class="literal">null</span>, options, mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnixChannelFactory</span></span><br><span class="line"><span class="keyword">static</span> FileChannel <span class="title function_">newFileChannel</span><span class="params">(<span class="type">int</span> dfd, UnixPath path, String pathForPermissionCheck, Set&lt;? extends OpenOption&gt; options, <span class="type">int</span> mode)</span> <span class="keyword">throws</span> UnixException &#123;</span><br><span class="line">    <span class="type">FileDescriptor</span> <span class="variable">fdObj</span> <span class="operator">=</span> open(dfd, path, pathForPermissionCheck, flags, mode);</span><br><span class="line">    <span class="keyword">return</span> FileChannelImpl.open(fdObj, path.toString(), flags.read, flags.write, flags.append, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>newOutputStream</code>的实现是<code>Channels#newOutputStream</code>, 返回了一个匿名内部类<code>OutputStream</code>, <code>write</code>时将<code>byte[]</code>转为<code>ByteBuffer</code>, 使用channel的锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Channels</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> OutputStream <span class="title function_">newOutputStream</span><span class="params">(<span class="keyword">final</span> WritableByteChannel ch)</span> &#123;</span><br><span class="line">    checkNotNull(ch, <span class="string">&quot;ch&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OutputStream</span>() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> <span class="type">ByteBuffer</span> <span class="variable">bb</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="type">byte</span>[] bs = <span class="literal">null</span>;       <span class="comment">// Invoker&#x27;s previous array</span></span><br><span class="line">            <span class="keyword">private</span> <span class="type">byte</span>[] b1 = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> b)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="keyword">if</span> (b1 == <span class="literal">null</span>)</span><br><span class="line">                    b1 = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1</span>];</span><br><span class="line">                b1[<span class="number">0</span>] = (<span class="type">byte</span>)b;</span><br><span class="line">                <span class="built_in">this</span>.write(b1);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">byte</span>[] bs, <span class="type">int</span> off, <span class="type">int</span> len)</span></span><br><span class="line">                <span class="keyword">throws</span> IOException</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> ((off &lt; <span class="number">0</span>) || (off &gt; bs.length) || (len &lt; <span class="number">0</span>) ||</span><br><span class="line">                    ((off + len) &gt; bs.length) || ((off + len) &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">bb</span> <span class="operator">=</span> ((<span class="built_in">this</span>.bs == bs)</span><br><span class="line">                                    ? <span class="built_in">this</span>.bb</span><br><span class="line">                                    : ByteBuffer.wrap(bs));</span><br><span class="line">                bb.limit(Math.min(off + len, bb.capacity()));</span><br><span class="line">                bb.position(off);</span><br><span class="line">                <span class="built_in">this</span>.bb = bb;</span><br><span class="line">                <span class="built_in">this</span>.bs = bs;</span><br><span class="line">                Channels.writeFully(ch, bb);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                ch.close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Channels</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">writeFully</span><span class="params">(WritableByteChannel ch, ByteBuffer bb)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (ch <span class="keyword">instanceof</span> SelectableChannel) &#123;</span><br><span class="line">        <span class="type">SelectableChannel</span> <span class="variable">sc</span> <span class="operator">=</span> (SelectableChannel)ch;</span><br><span class="line">        <span class="keyword">synchronized</span> (sc.blockingLock()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!sc.isBlocking())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalBlockingModeException</span>();</span><br><span class="line">            writeFullyImpl(ch, bb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        writeFullyImpl(ch, bb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Channels</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">writeFullyImpl</span><span class="params">(WritableByteChannel ch, ByteBuffer bb)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">while</span> (bb.remaining() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> ch.write(bb);</span><br><span class="line">        <span class="keyword">if</span> (n &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;no bytes written&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际调用的是<code>FileChannelImpl#write</code>, 最终使用<code>IOUtil#write</code>, 即direct memory进行写入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileChannelImpl</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">write</span><span class="params">(ByteBuffer src)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    ensureOpen();</span><br><span class="line">    <span class="keyword">synchronized</span> (positionLock) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ti</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            begin();</span><br><span class="line">            ti = threads.add();</span><br><span class="line">            <span class="keyword">if</span> (!isOpen())</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                n = IOUtil.write(fd, src, -<span class="number">1</span>, nd);</span><br><span class="line">            &#125; <span class="keyword">while</span> ((n == IOStatus.INTERRUPTED) &amp;&amp; isOpen());</span><br><span class="line">            <span class="keyword">return</span> IOStatus.normalize(n);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            threads.remove(ti);</span><br><span class="line">            end(n &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">assert</span> IOStatus.check(n);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IOUtil</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">write</span><span class="params">(FileDescriptor fd, ByteBuffer src, <span class="type">long</span> position, NativeDispatcher nd)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (src <span class="keyword">instanceof</span> DirectBuffer)</span><br><span class="line">        <span class="keyword">return</span> writeFromNativeBuffer(fd, src, position, nd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Substitute a native buffer</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> src.position();</span><br><span class="line">    <span class="type">int</span> <span class="variable">lim</span> <span class="operator">=</span> src.limit();</span><br><span class="line">    <span class="keyword">assert</span> (pos &lt;= lim);</span><br><span class="line">    <span class="type">int</span> <span class="variable">rem</span> <span class="operator">=</span> (pos &lt;= lim ? lim - pos : <span class="number">0</span>);</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">bb</span> <span class="operator">=</span> Util.getTemporaryDirectBuffer(rem);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        bb.put(src);</span><br><span class="line">        bb.flip();</span><br><span class="line">        <span class="comment">// Do not update src until we see how many bytes were written</span></span><br><span class="line">        src.position(pos);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> writeFromNativeBuffer(fd, bb, position, nd);</span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// now update src</span></span><br><span class="line">            src.position(pos + n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Util.offerFirstTemporaryDirectBuffer(bb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Direct-Memory"><a href="#Direct-Memory" class="headerlink" title="Direct Memory"></a>Direct Memory</h1><p>对于Java堆内存的介绍<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/spring-apps/enterprise/concepts-for-java-memory-management#direct-memory">Java memory management - Azure Spring Apps | Microsoft Learn</a>, 注意只有FullGC时Direct Memory才会被回收</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">Java8的文档</a>中搜索<code>MaxDirectMemorySize</code></p>
<blockquote>
<p>-XX:MaxDirectMemorySize&#x3D;size</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3773775/default-for-xxmaxdirectmemorysize">java - Default for XX:MaxDirectMemorySize - Stack Overflow</a>不设置默认值的话direct memory的大小与<code>-Xmx=size</code>有关</p>
<h2 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h2><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/20058489/is-there-a-way-to-measure-direct-memory-usage-in-java">Is there a way to measure direct memory usage in Java? - Stack Overflow</a></p>
<p>使用<code>ManagementFactory</code>获取<code>BufferPoolMXBean</code>, 读取<code>BufferPoolMXBean</code>的内存信息</p>
<p>LLM的回答</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">maxDirectMemory</span> <span class="operator">=</span> sun.misc.VM.maxDirectMemory();</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a href="/favorite/">star</a></li>
        
          <li><a href="/link/">link</a></li>
        
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Files-newOutputStream-%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">Files.newOutputStream()的优点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%BA%90%E7%A0%81"><span class="toc-number">1.1.</span> <span class="toc-text">查看源码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Direct-Memory"><span class="toc-number">2.</span> <span class="toc-text">Direct Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B"><span class="toc-number">2.2.</span> <span class="toc-text">查看</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&text=Files.newOutputStream().write()使用direct memory"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&title=Files.newOutputStream().write()使用direct memory"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&is_video=false&description=Files.newOutputStream().write()使用direct memory"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Files.newOutputStream().write()使用direct memory&body=Check out this article: https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&title=Files.newOutputStream().write()使用direct memory"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&title=Files.newOutputStream().write()使用direct memory"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&title=Files.newOutputStream().write()使用direct memory"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&title=Files.newOutputStream().write()使用direct memory"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&name=Files.newOutputStream().write()使用direct memory&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hahahaha123567.github.io/2024-05-31-Files.newOutputStream().write()%E5%AF%BC%E8%87%B4direct-memory-OOM.html&t=Files.newOutputStream().write()使用direct memory"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2017-2024
    hahahaha123567
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/favorite/">star</a></li><!--
     --><!--
       --><li><a href="/link/">link</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
