<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/snowman-32.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/snowman-32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/snowman-16.ico">
  <link rel="mask-icon" href="/images/snowman-32.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hahahaha123567.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.12.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="niconiconi">
<meta property="og:type" content="website">
<meta property="og:title" content="hahahaha123567">
<meta property="og:url" content="https://hahahaha123567.github.io/page/3/index.html">
<meta property="og:site_name" content="hahahaha123567">
<meta property="og:description" content="niconiconi">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="hahahaha123567">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://hahahaha123567.github.io/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>hahahaha123567</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">hahahaha123567</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">hahahaha123567</p>
  <div class="site-description" itemprop="description">niconiconi</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">61</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hahahaha123567" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hahahaha123567" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://bangumi.tv/user/hahahaha123567" title="Bangumi → http:&#x2F;&#x2F;bangumi.tv&#x2F;user&#x2F;hahahaha123567" rel="noopener" target="_blank">Bangumi</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://lovelive.ws/" title="https:&#x2F;&#x2F;lovelive.ws&#x2F;" rel="noopener" target="_blank">μ's</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2019-03-18-logback%E7%9A%84AsyncAppender%E4%BA%A7%E7%94%9F%E7%9A%84%E7%BA%BF%E7%A8%8B%E9%97%AE%E9%A2%98.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019-03-18-logback%E7%9A%84AsyncAppender%E4%BA%A7%E7%94%9F%E7%9A%84%E7%BA%BF%E7%A8%8B%E9%97%AE%E9%A2%98.html" class="post-title-link" itemprop="url">logback的AsyncAppender产生的线程问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-03-18 11:50:37" itemprop="dateCreated datePublished" datetime="2019-03-18T11:50:37+08:00">2019-03-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-07-01 20:33:32" itemprop="dateModified" datetime="2021-07-01T20:33:32+08:00">2021-07-01</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

            <div class="post-description">第一次发现并独立解决并发问题</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>项目里使用 logback+log4j 作为日志框架, 之前写了个mybatis插件处理日志, <a href="https://hahahaha123567.github.io/2019/03/18/2019-03-18-mybatis%E6%97%A5%E5%BF%97%E9%97%AE%E5%8F%B7%E6%9B%BF%E6%8D%A2/">mybatis日志问号替换</a></p>
<p>输出自定义日志后, 需要把框架默认的日志过滤掉, 原 <code>logback.xml</code> 如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;rollingFileAppender&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;com.yiwise.core.log.MybatisFilter&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;asyncRollingFileAppender&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.AsyncAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">discardingThreshold</span>&gt;</span>0<span class="tag">&lt;/<span class="name">discardingThreshold</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">queueSize</span>&gt;</span>512<span class="tag">&lt;/<span class="name">queueSize</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;rollingFileAppender&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;console&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;com.yiwise.core.log.MybatisFilter&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>有console, rollingFileAppender, asyncRollingFileAppender三个appender, 最后生效的分别是console和日志文件asyncRollingFileAppender三个appender</p>
<p>在mybatis插件中, 因为担心字段映射出错抛异常的时候, 不显示自定义sql, 此时框架默认sql也被我过滤导致看不到sql情况, 所以在异常的try-catch中使用MDC控制MybatisFilter这个过滤器的开关(即出现异常时关闭这个filter显示框架默认日志)</p>
<p>但在测试时, ide里运行, console中日志被正常过滤, 但生成的日志文件里过滤却失败, 明明filter配置相同结果却不同, 花了很久才找到原因</p>
<h1 id="问题产生原因"><a href="#问题产生原因" class="headerlink" title="问题产生原因"></a>问题产生原因</h1><p>AsyncAppender有个线程类Worker, 它是一个简单的线程类, 是AsyncAppender的后台线程, 所要做的工作是: 从buffer中取出event交给对应的appender进行后面的日志推送</p>
<p>AsyncAppender并不处理日志, 只是将日志缓冲到一个BlockingQueue里面去, 并在内部创建一个工作线程从队列头部获取日志, 之后将获取的日志循环记录到附加的其他appender上去, 从而达到不阻塞主线程的效果。因此AsynAppender仅仅充当事件转发器, 必须引用另一个appender来工作</p>
<p>在业务流程中使用了logback MDC(Mapped Diagnostic Context), 即将一些运行时的上下文数据通过logback打印出来</p>
<p>MDC内部<a target="_blank" rel="noopener" href="https://blog.csdn.net/a837199685/article/details/52712547">使用InheritableThreadLocal</a>实现, 默认实现从父线程到子线程的内容浅拷贝, 但filter是运行在asyncRollingFileAppender的线程中, 读不到业务在主线程中放到MDC的内容</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>filter中不再直接使用MDC, 而是用传进来的event去获取日志所记录的线程的MDC <code>getMDCPropertyMap</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> FilterReply <span class="title function_">decide</span><span class="params">(ILoggingEvent event)</span> &#123;</span><br><span class="line">    Map&lt;String, String&gt; mdcPropertyMap = event.getMDCPropertyMap();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2019-03-18-mybatis%E6%97%A5%E5%BF%97%E9%97%AE%E5%8F%B7%E6%9B%BF%E6%8D%A2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019-03-18-mybatis%E6%97%A5%E5%BF%97%E9%97%AE%E5%8F%B7%E6%9B%BF%E6%8D%A2.html" class="post-title-link" itemprop="url">mybatis日志问号替换</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2019-03-18 09:50:37 / 修改时间：16:52:40" itemprop="dateCreated datePublished" datetime="2019-03-18T09:50:37+08:00">2019-03-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

            <div class="post-description">自定义mybatis插件</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>项目里使用 logback+log4j 作为日志框架, mybatis 支持 log4j 作为日志框架, 默认即输出日志如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">==&gt;  Preparing: select * from idol where name = ?</span><br><span class="line">==&gt; Parameters: nico(String)</span><br><span class="line">&lt;==      Total: 1 </span><br></pre></td></tr></table></figure>

<p>每次验证sql都要手动替换问号很麻烦, 就写个插件直接打印实际执行的完整sql</p>
<h1 id="打印日志时机"><a href="#打印日志时机" class="headerlink" title="打印日志时机"></a>打印日志时机</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.ibatis.executor;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleExecutor</span> <span class="keyword">extends</span> <span class="title class_">BaseExecutor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">doQuery</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> ms.getConfiguration();</span><br><span class="line">            <span class="type">StatementHandler</span> <span class="variable">handler</span> <span class="operator">=</span> configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">            <span class="comment">// 打sql模板日志</span></span><br><span class="line">            stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">            <span class="comment">// 打实际参数</span></span><br><span class="line">            <span class="keyword">return</span> handler.&lt;E&gt;query(stmt, resultHandler);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeStatement(stmt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.ibatis.logging.jdbc;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ConnectionLogger</span> <span class="keyword">extends</span> <span class="title class_">BaseJdbcLogger</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] params)</span> &#123;</span><br><span class="line">        <span class="comment">// log sql template</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.ibatis.logging.jdbc;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">PreparedStatementLogger</span> <span class="keyword">extends</span> <span class="title class_">BaseJdbcLogger</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] params)</span> &#123;</span><br><span class="line">        <span class="comment">// log paramaters</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.ibatis.logging.jdbc;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ResultSetLogger</span> <span class="keyword">extends</span> <span class="title class_">BaseJdbcLogger</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] params)</span> &#123;</span><br><span class="line">        <span class="comment">// log total</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用到的Logger: MapperRegistry &lt;-&gt; Configuration -&gt; MappedStatement -&gt; Log</p>
<p>org.apache.ibatis.executor.Executor: update(), query()<br>增&#x2F;删&#x2F;改查</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>本来想通过侵入打日志代码的方式实现, 后来发现mybatis提供了<a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html#plugins">插件</a>功能, 可以<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fangjian0423/p/mybatis-interceptor.html">自定义sql执行流程</a></p>
<p>最终实现如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hahahaha123567@qq.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 注解拦截接口可选方法</span></span><br><span class="line"><span class="comment"> * Executor (update, query, flushStatements, commit, rollback, getTransaction, close, isClosed)</span></span><br><span class="line"><span class="comment"> * ParameterHandler (getParameterObject, setParameters)</span></span><br><span class="line"><span class="comment"> * ResultSetHandler (handleResultSets, handleOutputParameters)</span></span><br><span class="line"><span class="comment"> * StatementHandler (prepare, parameterize, batch, update, query)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2019/01/03</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">        @Signature(</span></span><br><span class="line"><span class="meta">                type = Executor.class,</span></span><br><span class="line"><span class="meta">                method = &quot;update&quot;,</span></span><br><span class="line"><span class="meta">                args = &#123;MappedStatement.class, Object.class&#125;),</span></span><br><span class="line"><span class="meta">        @Signature(</span></span><br><span class="line"><span class="meta">                type = Executor.class,</span></span><br><span class="line"><span class="meta">                method = &quot;query&quot;,</span></span><br><span class="line"><span class="meta">                args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(MybatisInterceptor.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Properties properties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getParameterValue</span><span class="params">(Object param)</span> &#123;</span><br><span class="line">        String value;</span><br><span class="line">        <span class="keyword">if</span> (param == <span class="literal">null</span>) &#123;</span><br><span class="line">            value = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            value = param.toString();</span><br><span class="line">            <span class="keyword">if</span> (param <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                value = <span class="string">&quot;&#x27;&quot;</span> + value + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (param <span class="keyword">instanceof</span> CodeDescEnum) &#123;</span><br><span class="line">                value = ((CodeDescEnum) param).getCode().toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Matcher.quoteReplacement(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">showSql</span><span class="params">(Configuration configuration, BoundSql boundSql)</span> &#123;</span><br><span class="line">        <span class="comment">// 去掉空白字符</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> boundSql.getSql().replaceAll(<span class="string">&quot;[\\s]+&quot;</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">parameterObject</span> <span class="operator">=</span> boundSql.getParameterObject();</span><br><span class="line">        List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(sql) &amp;&amp; Objects.nonNull(parameterObject) &amp;&amp; !CollectionUtils.isEmpty(parameterMappings)) &#123;</span><br><span class="line">            <span class="comment">// 替换参数</span></span><br><span class="line">            <span class="type">TypeHandlerRegistry</span> <span class="variable">typeHandlerRegistry</span> <span class="operator">=</span> configuration.getTypeHandlerRegistry();</span><br><span class="line">            <span class="keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">                <span class="comment">// 有对应的typeHandler</span></span><br><span class="line">                sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, getParameterValue(parameterObject));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 没有对应的typeHandler</span></span><br><span class="line">                <span class="type">MetaObject</span> <span class="variable">metaObject</span> <span class="operator">=</span> configuration.newMetaObject(parameterObject);</span><br><span class="line">                <span class="keyword">for</span> (ParameterMapping parameterMapping : parameterMappings) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">propertyName</span> <span class="operator">=</span> parameterMapping.getProperty();</span><br><span class="line">                    <span class="keyword">if</span> (metaObject.hasGetter(propertyName)) &#123;</span><br><span class="line">                        <span class="comment">// 从metaObject里取值</span></span><br><span class="line">                        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> metaObject.getValue(propertyName);</span><br><span class="line">                        sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, getParameterValue(obj));</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class="line">                        <span class="comment">// 从boundSql里取值</span></span><br><span class="line">                        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">                        sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, getParameterValue(obj));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sql;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">plugin</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(target, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">        MybatisInterceptor.properties = properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">        MybatisFilter.enable();</span><br><span class="line">        <span class="type">MappedStatement</span> <span class="variable">mappedStatement</span> <span class="operator">=</span> (MappedStatement) invocation.getArgs()[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sql参数</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">parameter</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (invocation.getArgs().length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            parameter = invocation.getArgs()[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> mappedStatement.getBoundSql(parameter);</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> mappedStatement.getConfiguration();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 统计sql执行时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Exception</span> <span class="variable">sqlException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            returnValue = invocation.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            MybatisFilter.disable();</span><br><span class="line">            sqlException = e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> (end - start);</span><br><span class="line">        <span class="comment">// sql执行位置的logger</span></span><br><span class="line">        <span class="type">Log</span> <span class="variable">statementLog</span> <span class="operator">=</span> mappedStatement.getStatementLog();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (returnValue != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (returnValue <span class="keyword">instanceof</span> Collection) &#123;</span><br><span class="line">                    <span class="comment">// executor.query()</span></span><br><span class="line">                    size = ((Collection) returnValue).size();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnValue <span class="keyword">instanceof</span> Number) &#123;</span><br><span class="line">                    <span class="comment">// executor.update()</span></span><br><span class="line">                    size = ((Number) returnValue).intValue();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;处理sql结果出错, returnValue类型为 &#123;&#125;&quot;</span>, returnValue.getClass().getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> showSql(configuration, boundSql);</span><br><span class="line">            statementLog.debug(String.format(<span class="string">&quot;sql执行耗时: %dms, 结果数: %d, %s&quot;</span>, time, size, sql));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            MybatisFilter.disable();</span><br><span class="line">            statementLog.error(String.format(<span class="string">&quot;[LogHub]mybatis拦截器格式化sql出错, 调用位置%s, sql模板: %s&quot;</span>, mappedStatement.getId(), boundSql.getSql()), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sqlException != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> sqlException;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把插件注册到mybatis</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource, PageHelper pageHelper, MybatisInterceptor mybatisInterceptor)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;==== sqlSessionFactory execute ====&quot;</span>);</span><br><span class="line"></span><br><span class="line">    VFS.addImplClass(SpringBootVFS.class);</span><br><span class="line"></span><br><span class="line">    <span class="type">SqlSessionFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加插件</span></span><br><span class="line">    Interceptor[] plugins = <span class="keyword">new</span> <span class="title class_">Interceptor</span>[]&#123;pageHelper, mybatisInterceptor&#125;;</span><br><span class="line">    bean.setPlugins(plugins);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加数据源</span></span><br><span class="line">    bean.setDataSource(dataSource);</span><br><span class="line">    <span class="comment">// 注册 *Mapper.xml 配置文件</span></span><br><span class="line">    <span class="type">PathMatchingResourcePatternResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PathMatchingResourcePatternResolver</span>();</span><br><span class="line">    bean.setMapperLocations(resolver.getResources(<span class="string">&quot;classpath*:/mapper/**/*Mapper.xml&quot;</span>));</span><br><span class="line">    bean.setTypeHandlersPackage(<span class="string">&quot;com.haha.model.enums&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> bean.getObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2019-03-15-%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%A3%85%E6%9C%BA%E8%AE%B0%E5%BD%95.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019-03-15-%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%A3%85%E6%9C%BA%E8%AE%B0%E5%BD%95.html" class="post-title-link" itemprop="url">第一次装机记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-03-15 20:50:37" itemprop="dateCreated datePublished" datetime="2019-03-15T20:50:37+08:00">2019-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-11-04 20:04:02" itemprop="dateModified" datetime="2021-11-04T20:04:02+08:00">2021-11-04</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>464</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

            <div class="post-description">i58400+GTX1066</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <table>
<thead>
<tr>
<th align="left">类型</th>
<th align="center">型号</th>
<th align="right">价格</th>
</tr>
</thead>
<tbody><tr>
<td align="left">cpu</td>
<td align="center">i5 8400</td>
<td align="right">1600</td>
</tr>
<tr>
<td align="left">主板</td>
<td align="center">微星 B360M</td>
<td align="right">740</td>
</tr>
<tr>
<td align="left">内存</td>
<td align="center">金士顿 DDR4 3000 8G</td>
<td align="right">400</td>
</tr>
<tr>
<td align="left">显卡</td>
<td align="center">GTX1066</td>
<td align="right">1700</td>
</tr>
<tr>
<td align="left">SSD</td>
<td align="center">intel 512G M.2</td>
<td align="right">800</td>
</tr>
<tr>
<td align="left">HDD</td>
<td align="center">希捷 2T7200转</td>
<td align="right">380</td>
</tr>
<tr>
<td align="left">电源</td>
<td align="center">鑫谷550w</td>
<td align="right">320</td>
</tr>
<tr>
<td align="left">机箱</td>
<td align="center">追风者416PTG</td>
<td align="right">290</td>
</tr>
<tr>
<td align="left">显示器</td>
<td align="center">AOC I2779VH</td>
<td align="right">1000</td>
</tr>
<tr>
<td align="left">total</td>
<td align="center"></td>
<td align="right">7230</td>
</tr>
</tbody></table>
<p>大二第一次给笔记本加内存和SSD才第一次对计算机硬件有了概念, 知直到大四第一次组装台式机才知道了许多即使对非cs专业的人来说都算是常识的事情:</p>
<ol>
<li>cpu连着主板(废话), 内存插在主板上(24&gt;13&gt;1), SSD插在主板上, 显卡插在主板上, HDD插在机箱里</li>
<li>机箱正面的几个孔和按钮(耳机, 麦克风, 开机, 重启)要手动连到主板上的对应位置</li>
<li>显卡提供VGA, HDMI等接口</li>
<li>HDD要连数据线和电源线</li>
<li>最麻烦的是各个组件连电源</li>
</ol>
<p>各种电脑配件决定价格和质量的参数:</p>
<ul>
<li>cpu: 主频&#x2F;实际一般直接看代数</li>
<li>显卡: 计算力&#x2F;实际一般直接看代数, 显存</li>
<li>内存: 大小, 频率, DDR代数</li>
<li>SSD: 大小, 接口</li>
<li>HDD: 大小, 转速</li>
<li>显示器: 大小, 材质, 频率, 分辨率</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2019-02-21-%E5%86%99Dockerfile%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019-02-21-%E5%86%99Dockerfile%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98.html" class="post-title-link" itemprop="url">写Dockerfile中遇到的问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2019-02-21 02:32:37 / 修改时间：02:45:30" itemprop="dateCreated datePublished" datetime="2019-02-21T02:32:37+08:00">2019-02-21</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

            <div class="post-description">大部分都是一些之前不知道的常识</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="文件映射"><a href="#文件映射" class="headerlink" title="文件映射"></a>文件映射</h1><p><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/volumes/">Use volumes | Docker Documentation</a></p>
<p><a target="_blank" rel="noopener" href="http://dockone.io/article/128">深入理解Docker Volume（一） - DockOne.io</a></p>
<p><a target="_blank" rel="noopener" href="http://dockone.io/article/129">深入理解Docker Volume（二） - DockOne.io</a></p>
<h2 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 运行时指定</span></span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -v /container/data hello</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Dockerfile中指定</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> /container/data</span></span><br></pre></td></tr></table></figure>

<p>docker 会在 host 上创建一个目录并挂载到 container 的 <code>/container/data</code></p>
<p>创建的目录默认路径在 <code>/var/lib/docker</code></p>
<h2 id="bind-mount"><a href="#bind-mount" class="headerlink" title="bind-mount"></a>bind-mount</h2><p><code>docker run -v /host/data:/container/data hello</code> </p>
<p>将 <code>host</code> 的 <code>/host/data</code> 目录挂载到了 <code>container</code> 的 <code>/container/data</code> 目录下</p>
<h2 id="覆盖"><a href="#覆盖" class="headerlink" title="覆盖"></a>覆盖</h2><p>因为是“挂载”, host 的目录内容会覆盖 container 的目录:</p>
<ul>
<li>如果是普通 mount 则 container 内的目录一定会被覆盖为空</li>
<li>如果是 bind-mount, 但指定的 host 目录原本不存在, 则 container 目录也会被覆盖为空</li>
</ul>
<p>todo: volume 的顺序是否会影响文件是否被覆盖</p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000015684472">Docker volume 挂载时文件或文件夹不存在 - Keep Coding - SegmentFault 思否</a></p>
<h1 id="shell脚本"><a href="#shell脚本" class="headerlink" title="shell脚本"></a>shell脚本</h1><h2 id="终端打印彩色字体"><a href="#终端打印彩色字体" class="headerlink" title="终端打印彩色字体"></a>终端打印彩色字体</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m 我是红色 \033[0m&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="shell的比较选项"><a href="#shell的比较选项" class="headerlink" title="shell的比较选项"></a>shell的比较选项</h2><p><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/linux/l-bash-test.html">Linux 技巧: Bash 测试和比较函数</a></p>
<h2 id="shell读参数"><a href="#shell读参数" class="headerlink" title="shell读参数"></a>shell读参数</h2><p><a target="_blank" rel="noopener" href="http://billie66.github.io/TLCL/book/chap33.html">位置参数 - TLCL</a></p>
<h2 id="星际选手"><a href="#星际选手" class="headerlink" title="星际选手"></a>星际选手</h2><p><code>sed</code> 写成了 <code>set</code>, 两个单词高亮一样, 查了几个小时, 一直以为是脚本没执行, 最后才发现是命令写错了</p>
<h1 id="持续运行"><a href="#持续运行" class="headerlink" title="持续运行"></a>持续运行</h1><p>docker 执行完脚本后就会自动停止</p>
<p>为了使其正常工作, 一般用 <code>CMD [&quot;...&quot;]</code> 显式使其执行命令, 或者使用 tailf 查看日志等</p>
<h1 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h1><h2 id="容器运行时"><a href="#容器运行时" class="headerlink" title="容器运行时"></a>容器运行时</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入容器内部查看程序的日志</span></span><br><span class="line">docker <span class="built_in">exec</span> -it hello bash</span><br></pre></td></tr></table></figure>

<h2 id="容器停止后"><a href="#容器停止后" class="headerlink" title="容器停止后"></a>容器停止后</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 host 上查看 hello 输出的日志, 即 hello 内部打印到 bash 的信息</span></span><br><span class="line">docker logs hello</span><br></pre></td></tr></table></figure>

<h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><h2 id="document"><a href="#document" class="headerlink" title="document"></a>document</h2><p><a target="_blank" rel="noopener" href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">Best practices for writing Dockerfiles | Docker Documentation</a></p>
<p><a target="_blank" rel="noopener" href="https://yeasy.gitbooks.io/docker_practice/appendix/best_practices.html">附录四：Dockerfile 最佳实践 · Docker —— 从入门到实践</a></p>
<h2 id="example"><a href="#example" class="headerlink" title="example"></a>example</h2><p><a target="_blank" rel="noopener" href="https://hub.docker.com/_/redis">redis - Docker Hub</a></p>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/_/nginx">nginx - Docker Hub</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2019-02-21-Java%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9B%BF%E6%8D%A2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019-02-21-Java%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9B%BF%E6%8D%A2.html" class="post-title-link" itemprop="url">Java中的字符串替换</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2019-02-21 02:32:36 / 修改时间：02:44:32" itemprop="dateCreated datePublished" datetime="2019-02-21T02:32:36+08:00">2019-02-21</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>627</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

            <div class="post-description">正则替换要注意 $ 和 \</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="字符串替换"><a href="#字符串替换" class="headerlink" title="字符串替换"></a>字符串替换</h1><h2 id="简单替换"><a href="#简单替换" class="headerlink" title="简单替换"></a>简单替换</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// String.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">replace</span><span class="params">(<span class="type">char</span> oldChar, <span class="type">char</span> newChar)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">replace</span><span class="params">(CharSequence target, CharSequence replacement)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="正则替换"><a href="#正则替换" class="headerlink" title="正则替换"></a>正则替换</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// String.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">replaceFirst</span><span class="params">(String regex, String replacement)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">replaceAll</span><span class="params">(String regex, String replacement)</span>;</span><br></pre></td></tr></table></figure>

<p><code>str.replaceFirst(regex, repl)</code> 等价于 <code>Pattern.compile(regex).matcher(str).replaceFirst(repl)</code></p>
<p>replacement 中的反斜杠(\) 美元符号($) 可能会导致结果异常, 如果需要的话使用 <code>Matcher.quoteReplacement(java.lang.String)</code> 进行处理</p>
<h1 id="特殊处理"><a href="#特殊处理" class="headerlink" title="特殊处理"></a>特殊处理</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Matcher.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">replaceFirst</span><span class="params">(String replacement)</span>;</span><br></pre></td></tr></table></figure>
<p>replacement 中的反斜杠(\) 美元符号($) 可能会导致结果异常, 反斜杠可能会被用于转义, 美元符号可能会被当成被匹配到的子序列的引用</p>
<hr>
<p>参考资料</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ggjucheng/p/3423731.html">JAVA正则表达式：Pattern类与Matcher类详解(转) - ggjucheng - 博客园</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2019-02-10-%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019-02-10-%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91.html" class="post-title-link" itemprop="url">科学上网</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-02-10 06:30:14" itemprop="dateCreated datePublished" datetime="2019-02-10T06:30:14+08:00">2019-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-07-14 11:11:59" itemprop="dateModified" datetime="2021-07-14T11:11:59+08:00">2021-07-14</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>471</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

            <div class="post-description">记录一下脚本/客户端地址</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="server"><a href="#server" class="headerlink" title="server"></a>server</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y wget</span><br><span class="line">wget --no-check-certificate -O shadowsocks-all.sh https://raw.githubusercontent.com/teddysun/shadowsocks_install/master/shadowsocks-all.sh</span><br><span class="line"><span class="built_in">chmod</span> +x shadowsocks-all.sh</span><br><span class="line">./shadowsocks-all.sh 2&gt;&amp;1 | <span class="built_in">tee</span> shadowsocks-all.log</span><br></pre></td></tr></table></figure>

<p><strong>centos8</strong><br>编辑 <code>shadowsocks-all.sh</code> 将 <code>install_dependencies()</code> 中的python替换为python39</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y python39 python39-devel python39-setuptools</span><br><span class="line"><span class="built_in">ln</span> -s /usr/bin/python3 /usr/bin/python</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br><span class="line">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure>

<h1 id="client"><a href="#client" class="headerlink" title="client"></a>client</h1><p><a target="_blank" rel="noopener" href="http://www.ginfem.com/appclient.html">银杏</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2018-12-16-%E7%94%A8%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8A%A0%E9%94%81.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018-12-16-%E7%94%A8%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8A%A0%E9%94%81.html" class="post-title-link" itemprop="url">用字符串加锁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-16 01:32:36" itemprop="dateCreated datePublished" datetime="2018-12-16T01:32:36+08:00">2018-12-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-07-01 20:32:02" itemprop="dateModified" datetime="2021-07-01T20:32:02+08:00">2021-07-01</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

            <div class="post-description">多线程编程 synchronized 加锁问题</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="问题场景"><a href="#问题场景" class="headerlink" title="问题场景"></a>问题场景</h1><p>使用 redis 做缓存, 在缓存中查询不到时要先加锁再去 db 中查, 这时用查询 redis 时的锁作为 key 进行加锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;K, T&gt; T <span class="title function_">findCache</span><span class="params">(K key, <span class="type">long</span> timeout, TimeUnit unit, Class&lt;T&gt; clazz, Callable&lt;T&gt; loadBack)</span> &#123;</span><br><span class="line">    <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> redisService.get(key, clazz);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != result) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;load cache ======== &#123;&#125;.&quot;</span>, key);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (pool.intern(key)) &#123;</span><br><span class="line">            result = redisService.get(key, clazz);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != result) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;load cache ======== &#123;&#125;.&quot;</span>, key);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            result = doLoadBack(loadBack);</span><br><span class="line">            <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">                redisService.set(key, result, timeout, unit);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="不能直接用-String-对象作为锁"><a href="#不能直接用-String-对象作为锁" class="headerlink" title="不能直接用 String 对象作为锁"></a>不能直接用 String 对象作为锁</h1><p>synchronizd 加锁是基于对象进行的, value内容相同的两个 String, 如果不是同一个对象, 期望的加锁行为就无法完成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NicoThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String s;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">NicoThread</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.s = s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (s) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">                System.out.println(name + <span class="string">&quot;: begin sleep&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                System.out.println(name + <span class="string">&quot;: end sleep&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="string">&quot;niconiconi&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;niconiconi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">NicoThread</span>(s1).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">NicoThread</span>(s2).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 输出</span><br><span class="line">Thread-0: begin sleep</span><br><span class="line">Thread-1: begin sleep</span><br><span class="line">Thread-1: end sleep</span><br><span class="line">Thread-0: end sleep</span><br><span class="line">// 同步失败</span><br></pre></td></tr></table></figure>

<h1 id="使用-intern-对象加锁"><a href="#使用-intern-对象加锁" class="headerlink" title="使用 intern() 对象加锁?"></a>使用 intern() 对象加锁?</h1><p>value内容相同的两个 String, intern() 后得到的是 String 常量池中的同一个对象, 可以完成期望的锁操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// synchronized(s) &#123;&#125;</span><br><span class="line">synchronized(s.intern()) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="intern-的-gc-问题"><a href="#intern-的-gc-问题" class="headerlink" title="intern() 的 gc 问题"></a>intern() 的 gc 问题</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yhlx/p/3498387.html">在jdk7下慎用String.intern()作为synchronized的对象锁 - 绝望生鱼片 - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://tech.meituan.com/in_depth_understanding_string_intern.html">深入解析String#intern</a></p>
<p>频繁调用 intern() 可能产生内存问题, 为了解决这个问题, 可以自定义一个 ConcurrentHashMap&lt;String, Object&gt; 用来储存传入的 key 与实际锁的对象</p>
<h1 id="guava-的-interner-实现"><a href="#guava-的-interner-实现" class="headerlink" title="guava 的 interner 实现"></a>guava 的 interner 实现</h1><p><a target="_blank" rel="noopener" href="https://google.github.io/guava/releases/21.0/api/docs/com/google/common/collect/Interner.html">api文档</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private Interner&lt;String&gt; interner = Interners.&lt;String&gt;newWeakInterner();</span><br><span class="line"></span><br><span class="line">synchronized(interner.intern(str)) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="类似数据结构"><a href="#类似数据结构" class="headerlink" title="类似数据结构"></a>类似数据结构</h1><p>guava 的 cache 是在内存中用 map 做缓存</p>
<p><a target="_blank" rel="noopener" href="https://google.github.io/guava/releases/23.5-jre/api/docs/">https://google.github.io/guava/releases/23.5-jre/api/docs/</a></p>
<hr>
<p>参考资料</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3972841/when-is-it-beneficial-to-flyweight-strings-in-java">When is it beneficial to flyweight Strings in Java? - Stack Overflow</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/133988/synchronizing-on-string-objects-in-java">multithreading - Synchronizing on String objects in Java - Stack Overflow</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/5639870/simple-java-name-based-locks">locking - Simple Java name based locks? - Stack Overflow</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2018-12-15-Java%E7%94%A8%E6%B3%A8%E8%A7%A3%E5%81%9A%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018-12-15-Java%E7%94%A8%E6%B3%A8%E8%A7%A3%E5%81%9A%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C.html" class="post-title-link" itemprop="url">Java用注解做参数校验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-15 01:32:08" itemprop="dateCreated datePublished" datetime="2018-12-15T01:32:08+08:00">2018-12-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-12-18 01:53:26" itemprop="dateModified" datetime="2018-12-18T01:53:26+08:00">2018-12-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>547</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

            <div class="post-description">介绍几种常见的 @NotNull 注解</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JSR-303-Bean-Validation"><a href="#JSR-303-Bean-Validation" class="headerlink" title="JSR 303 Bean Validation"></a>JSR 303 Bean Validation</h1><p><code>javax.validation.constraints</code></p>
<ul>
<li>NotNull</li>
<li>NotEmpty</li>
<li>NotBlank</li>
<li>…</li>
</ul>
<p>常用 Hibernate Validator 实现, 在 controller 层用 @Validated 开启, 在运行时校验不通过则报错</p>
<h1 id="JSR-305-Annotations-for-Software-Defect-Detection"><a href="#JSR-305-Annotations-for-Software-Defect-Detection" class="headerlink" title="JSR 305 Annotations for Software Defect Detection"></a>JSR 305 Annotations for Software Defect Detection</h1><p><code>org.springframework.lang</code></p>
<ul>
<li>NonNull</li>
<li>Nullable</li>
</ul>
<p>提供给ide做判断提示, 在运行时不起作用</p>
<h1 id="Jetbrains-家的注解"><a href="#Jetbrains-家的注解" class="headerlink" title="Jetbrains 家的注解"></a>Jetbrains 家的注解</h1><p>涵盖了 JSR 305 的规范, 还有额外的 @Contract @TestOnly 等</p>
<p><a target="_blank" rel="noopener" href="https://www.jetbrains.com/help/idea/annotating-source-code.html">官网英文文档</a><br>(Jetbrains 家的文档是真的好)</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/24778947">中文文档(不)</a></p>
<h1 id="几个常识"><a href="#几个常识" class="headerlink" title="几个常识"></a>几个常识</h1><h3 id="JCP"><a href="#JCP" class="headerlink" title="JCP"></a>JCP</h3><p>Java Community Process, 由Sun创建, 用来发展和更新Java技术规范, 参考实现(RI), 技术兼容包(TCK)</p>
<h3 id="JSR"><a href="#JSR" class="headerlink" title="JSR"></a>JSR</h3><p>Java Specification Requests, JCP 成员向委员会提交的 Java 发展议案，经过一系列流程后，如果通过会成为 JEP</p>
<h3 id="JEP"><a href="#JEP" class="headerlink" title="JEP"></a>JEP</h3><p>JDK Enhancement Proposals, JDK的版本变化将从这些提案中选取</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://www.oschina.net/question/3838659_2278450">JAVA中@NotNull和@Nonnull有什么区别？ - 开源中国</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/31433bcaa1a5">JDK 版本变化 - 简书</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2018-08-13-java-util-concurrent.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018-08-13-java-util-concurrent.html" class="post-title-link" itemprop="url">java.util.concurrent</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-08-13 20:47:52" itemprop="dateCreated datePublished" datetime="2018-08-13T20:47:52+08:00">2018-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-11-05 15:54:45" itemprop="dateModified" datetime="2021-11-05T15:54:45+08:00">2021-11-05</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

            <div class="post-description">Java 的并行除了直接对线程进行操作，还有 java.tuil.concurrent 包中的这些高级并发特性</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Concurrent-包"><a href="#Concurrent-包" class="headerlink" title="Concurrent 包"></a>Concurrent 包</h1><h2 id="1-Lock"><a href="#1-Lock" class="headerlink" title="1. Lock"></a>1. Lock</h2><p>Lock 对象的工作机制类似于同步代码块使用的 synchronized，在某一时刻只允许一个线程拥有锁对象</p>
<p>通过它们关联的 Condition 对象，锁对象也支持 wait&#x2F;notify 机制</p>
<p>一个 Lock 对象和一个 synchronized 代码块之间的主要不同点是：</p>
<ul>
<li>synchronized 代码块不能够保证进入访问等待的线程的先后顺序</li>
<li>你不能够传递任何参数给一个 synchronized 代码块的入口。因此，对于 synchronized 代码块的访问等待设置超时时间是不可能的事情</li>
<li>synchronized 块必须被完整地包含在单个方法里。而一个 Lock 对象可以把它的 lock() 和 unlock() 方法的调用放在不同的方法里</li>
</ul>
<p>Lock 加锁的方式很多：</p>
<ul>
<li>lock()</li>
<li>lockInterruptibly()</li>
<li>tryLock()</li>
<li>tryLock(long timeout, TimeUnit timeUnit)</li>
</ul>
<p>实现：<code>ReentrantLock</code> </p>
<h3 id="1-1-ReadWriteLock"><a href="#1-1-ReadWriteLock" class="headerlink" title="1.1 ReadWriteLock"></a>1.1 ReadWriteLock</h3><p>实现：<code>ReentrantReadWriteLock</code> </p>
<ul>
<li><strong>读锁</strong>：如果没有任何写操作线程锁定 ReadWriteLock，并且没有任何写操作线程要求一个写锁(但还没有获得该锁)。因此，可以有多个读操作线程对该锁进行锁定</li>
<li><strong>写锁</strong>：如果没有任何读操作或者写操作。因此，在写操作的时候，只能有一个线程对该锁进行锁定</li>
</ul>
<h2 id="2-Future"><a href="#2-Future" class="headerlink" title="2. Future"></a>2. Future</h2><p>Future 的核心思想是：一个方法 f，计算过程可能非常耗时，等待f返回，显然不明智</p>
<p>可以在调用 f 的时候，立马返回一个 Future，可以通过 Future 这个数据结构去控制方法f的计算过程。</p>
<p>这里的<strong>控制</strong>包括：</p>
<ol>
<li>get：获取计算结果（如果还没计算完，也是必须等待的）</li>
<li>cancel：还没计算完，可以取消计算过程</li>
<li>isDone：判断是否计算完</li>
<li>isCancelled：判断计算是否被取消</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Callable&lt;String&gt; callable = () -&gt; &#123;</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;niconiconi&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">FutureTask&lt;String&gt; task = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(callable);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(task).start();</span><br><span class="line"><span class="type">String</span> <span class="variable">say</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    say = task.get();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(say);</span><br></pre></td></tr></table></figure>

<p>源码分析见 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/cz123/p/7693064.html">彻底理解Java的Future模式 - 大诚挚 - 博客园</a></p>
<h2 id="3-Executor"><a href="#3-Executor" class="headerlink" title="3. Executor"></a>3. Executor</h2><p>Java.util.concurrent 包定义了三种 executor 接口： </p>
<ul>
<li>Executor，支持加载新任务的简单接口</li>
<li>ExecutorService，Executor 的子接口，增加了帮助管理任务和executor本身的生命周期的功能</li>
<li>ScheduledExecutorService，ExecutorService 的子接口，支持周期性地执行任务</li>
</ul>
<h3 id="3-1-Executor"><a href="#3-1-Executor" class="headerlink" title="3.1 Executor"></a>3.1 Executor</h3><p>Executor 接口只定义了一个方法 execute，被设计用来代替一般的创建线程惯例 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// r implements Runnable</span></span><br><span class="line"><span class="comment">// 自己控制线程</span></span><br><span class="line">(<span class="keyword">new</span> <span class="title class_">Thread</span>(r)).start();</span><br><span class="line"><span class="comment">// 用 executor</span></span><br><span class="line">e.execute(r);</span><br></pre></td></tr></table></figure>

<p>对于 execute 方法的实现并没有特殊要求。低级的实现只是创建一个新的线程并立即执行</p>
<p>但更有可能是使用一个已经存在的工作线程（worker Threads）去执行 r，或者将 r 放在一个执行队列中等待工作线程有空的时候再执行 </p>
<h3 id="3-2-ExecutorService"><a href="#3-2-ExecutorService" class="headerlink" title="3.2 ExecutorService"></a>3.2 ExecutorService</h3><p>ExecutorService 接口提供了另一个相似的 submit 方法，但比 execute 更加通用</p>
<p>和 execute 一样，submit 接受 Runnable 对象，但也接受 Callable 对象，Callable 允许任务执行后返回一个值</p>
<p>Submit 方法返回 Future 对象，Future 对象被用来接收 Callable 返回的值，并管理 Callable 和 Runnable 对象所代表的任务 </p>
<p>常用实现：ThreadPoolExecutor</p>
<ul>
<li>Executors.newFixedThreadPool() : ThreadPoolExecutor</li>
<li>Executors.newCachedThreadPool() : ThreadPoolExecutor 一个使用可扩展线程池的 executor，拥有这种线程池的 executor 适合执行生命周期较短的任务</li>
<li>Executors.newSingleThreadExecutor() : FinalizableDelegatedExecutorService 一个只有一个工作线程的executor</li>
</ul>
<h3 id="3-3-ScheduledExecutorService"><a href="#3-3-ScheduledExecutorService" class="headerlink" title="3.3 ScheduledExecutorService"></a>3.3 ScheduledExecutorService</h3><p>ScheduledExecutorService 接口为它的父类 ExecutorService 的行为提供计划，允许在执行 Runnable 和 Callable 任务之前停顿一段时间</p>
<p>接口定义了 scheduleAtFixedRate 和 scheduleWithFixedDelay，这两个方法以特定的时间间隔重复地执行特定任务 </p>
<p>常用实现：ScheduledThreadPoolExecutor</p>
<ul>
<li>Executors.newScheduledThreadPool() : ScheduledThreadPoolExecutor</li>
</ul>
<h3 id="3-4-thread-pool"><a href="#3-4-thread-pool" class="headerlink" title="3.4 thread pool"></a>3.4 thread pool</h3><p>Thread 对象占用了大量的内存，在一个大型应用中，分配和释放线程对象会造成大量的线程管理开支 </p>
<p>使用工作线程可以减少创建线程的资源浪费，工作线程是不属于特定某个 Runnable 和 Callable 任务，经常用来执行多个任务 </p>
<p>大部分 java.util.concurrent 中的 executor 实现类使用了工作线程(worker threads)的线程池</p>
<h3 id="3-5-the-fixed-thread-pool"><a href="#3-5-the-fixed-thread-pool" class="headerlink" title="3.5 the fixed thread pool"></a>3.5 the fixed thread pool</h3><p>Executors.newFixedThreadPool()</p>
<h5 id="what"><a href="#what" class="headerlink" title="what"></a>what</h5><p>一种常用的线程池是固定线程池，这种线程池有特定数量的线程在运行，如果一个线程在使用过程中意外停止(如抛出未捕获的异常)，它会自动被另一个新线程替代</p>
<h5 id="how"><a href="#how" class="headerlink" title="how"></a>how</h5><p>任务通过一个内部的任务队列提交给线程池执行，此任务队列可以在活动任务数量大于线程池中工作线程个数时，存储多余的活动任务 </p>
<h5 id="why"><a href="#why" class="headerlink" title="why"></a>why</h5><p>“固定大小线程池”的一个好处是”优雅的缓冲”</p>
<p>考虑一个web应用服务，它的每一个线程只处理一个HTTP请求。如果这个应用简单地为每一个新来的请求创建一个新的处理线程，那么，当请求数量足够多时，线程占用的资源总和将超过系统的承受能力，服务器会因此忽然停止对所有请求的应答(常见的内存溢出)</p>
<p>而在使用固定大小线程池后，即使请求数量超出工作线程能够处理的请求上限，但是新来的HTTP请求会被暂时存放在消息队列中，当出现空闲的工作线程后，这些HTTP请求就会得到及时的处理 </p>
<h2 id="4-Fork-x2F-Join"><a href="#4-Fork-x2F-Join" class="headerlink" title="4. Fork&#x2F;Join"></a>4. Fork&#x2F;Join</h2><p>Java SE 7 中的特性，fork&#x2F;join 框架帮助你创建多进程应用。它被设计用来完成可以分成很多小进程的工作，目的是使用所有可用的进程来提升你的应用的性能 </p>
<p>像任何 ExecutorService 一样，fork&#x2F;join 框架把任务分发给线程池中工作线程。不同的是，因为 fork&#x2F;join 框架使用 work-stealing 算法——完成工作的工作线程可以从其他还在忙碌的线程那里偷任务来执行 </p>
<p>fork&#x2F;join 框架的核心是 ForkJoinPool 类，一个 AbstractExecutorService 的扩展类；ForkJoinPool 实现了核心的work-stealing算法，能够执行 ForkJoinTask 任务 </p>
<h3 id="4-1-思路"><a href="#4-1-思路" class="headerlink" title="4.1 思路"></a>4.1 思路</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (此部分工作足够小) &#123;</span><br><span class="line">  直接干活</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  把工作分成两部分，  </span><br><span class="line">  调用完成这两部分的代码，并等待结果返回</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把以上代码封装成ForkJoinTask子类</p>
<p>特别地作为更具体的类型 RecursiveAction 或 RecursiveTask (可以返回结果)</p>
<h3 id="4-2-例子"><a href="#4-2-例子" class="headerlink" title="4.2 例子"></a>4.2 例子</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RecursiveAction, execute without return value</span></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ForkJoinPool;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RecursiveAction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRecursiveAction</span> <span class="keyword">extends</span> <span class="title class_">RecursiveAction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">workLoad</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyRecursiveAction</span><span class="params">(<span class="type">long</span> workLoad)</span> &#123; <span class="built_in">this</span>.workLoad = workLoad; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.workLoad &gt; <span class="number">16</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Splitting workLoad : &quot;</span> + <span class="built_in">this</span>.workLoad);</span><br><span class="line"></span><br><span class="line">            List&lt;MyRecursiveAction&gt; subtasks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(createSubtasks());</span><br><span class="line">            <span class="keyword">for</span>(RecursiveAction subtask : subtasks)&#123;</span><br><span class="line">                subtask.fork();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Doing workLoad myself: &quot;</span> + <span class="built_in">this</span>.workLoad);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;MyRecursiveAction&gt; <span class="title function_">createSubtasks</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;MyRecursiveAction&gt; subtasks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">MyRecursiveAction</span> <span class="variable">subtask1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRecursiveAction</span>(<span class="built_in">this</span>.workLoad / <span class="number">2</span>);</span><br><span class="line">        <span class="type">MyRecursiveAction</span> <span class="variable">subtask2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRecursiveAction</span>(<span class="built_in">this</span>.workLoad / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        subtasks.add(subtask1);</span><br><span class="line">        subtasks.add(subtask2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> subtasks;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(<span class="number">4</span>);</span><br><span class="line">        <span class="type">MyRecursiveAction</span> <span class="variable">myRecursiveAction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRecursiveAction</span>(<span class="number">24</span>);</span><br><span class="line"></span><br><span class="line">        forkJoinPool.invoke(myRecursiveAction);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RecursiveTask, execute with return value</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRecursiveTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Long&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">workLoad</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyRecursiveTask</span><span class="params">(<span class="type">long</span> workLoad)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.workLoad = workLoad;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Long <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.workLoad &gt; <span class="number">16</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Splitting workLoad : &quot;</span> + <span class="built_in">this</span>.workLoad);</span><br><span class="line"></span><br><span class="line">            List&lt;MyRecursiveTask&gt; subtasks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(createSubtasks());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(MyRecursiveTask subtask : subtasks)&#123;</span><br><span class="line">                subtask.fork();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(MyRecursiveTask subtask : subtasks) &#123;</span><br><span class="line">                result += subtask.join();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Doing workLoad myself: &quot;</span> + <span class="built_in">this</span>.workLoad);</span><br><span class="line">            <span class="keyword">return</span> workLoad * <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;MyRecursiveTask&gt; <span class="title function_">createSubtasks</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;MyRecursiveTask&gt; subtasks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">MyRecursiveTask</span> <span class="variable">subtask1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRecursiveTask</span>(<span class="built_in">this</span>.workLoad / <span class="number">2</span>);</span><br><span class="line">        <span class="type">MyRecursiveTask</span> <span class="variable">subtask2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRecursiveTask</span>(<span class="built_in">this</span>.workLoad / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        subtasks.add(subtask1);</span><br><span class="line">        subtasks.add(subtask2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> subtasks;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(<span class="number">4</span>);</span><br><span class="line">        <span class="type">MyRecursiveTask</span> <span class="variable">myRecursiveTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRecursiveTask</span>(<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">mergedResult</span> <span class="operator">=</span> forkJoinPool.invoke(myRecursiveTask);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;mergedResult = &quot;</span> + mergedResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-work-stealing"><a href="#4-3-work-stealing" class="headerlink" title="4.3 work-stealing"></a>4.3 work-stealing</h3><p>调度策略：</p>
<ul>
<li>每一个工作线程维护自己的调度队列中的可运行任务 </li>
<li>队列以 deque 的形式被维护，不仅支持后进先出 —— <code>LIFO</code> 的 <code>push</code> 和 <code>pop</code> 操作，还支持先进先出 —— <code>FIFO</code> 的 <code>take</code> 操作 </li>
<li>对于一个给定的工作线程来说，任务所产生的子任务将会被放入到工作者自己的双端队列中 </li>
<li>工作线程使用后进先出 —— <code>LIFO</code>（最新的元素优先）的顺序，通过弹出任务来处理队列中的任务 </li>
<li>当一个工作线程的本地没有任务去运行的时候，它将使用先进先出 —— <code>FIFO</code>的规则尝试随机的从别的工作线程中拿（『窃取』）一个任务去运行 </li>
<li>当一个工作线程触及了<code>join</code>操作，如果可能的话它将处理其他任务，直到目标任务被告知已经结束（通过 <code>isDone</code> 方法）。所有的任务都会无阻塞的完成 </li>
<li>当一个工作线程无法再从其他线程中获取任务和失败处理的时候，它就会退出（通过<code>yield</code>、<code>sleep</code>和&#x2F;或者优先级调整）并经过一段时间之后再度尝试直到所有的工作线程都被告知他们都处于空闲的状态；在这种情况下，他们都会阻塞直到其他的任务再度被上层调用</li>
</ul>
<p>使用后进先出 —— <code>LIFO</code>用来处理每个工作线程的自己任务，但是使用先进先出 —— <code>FIFO</code>规则用于获取别的任务，这是一种被广泛使用的进行递归<code>Fork/Join</code>设计的一种调优手段 </p>
<p>让窃取任务的线程从队列拥有者相反的方向进行操作会减少线程竞争。同样体现了递归分治算法的大任务优先策略。因此，更早期被窃取的任务有可能会提供一个更大的单元任务，从而使得窃取线程能够在将来进行递归分解 </p>
<p>作为上述规则的一个后果，对于一些基础的操作而言，使用相对较小粒度的任务比那些仅仅使用粗粒度划分的任务以及那些没有使用递归分解的任务的运行速度要快。尽管相关的少数任务在大多数的<code>Fork/Join</code>框架中会被其他工作线程窃取，但是创建许多组织良好的任务意味着只要有一个工作线程处于可运行的状态，那么这个任务就有可能被执行 </p>
<h2 id="5-Concurrent-Collection"><a href="#5-Concurrent-Collection" class="headerlink" title="5. Concurrent Collection"></a>5. Concurrent Collection</h2><h3 id="5-1-BlockingQueue"><a href="#5-1-BlockingQueue" class="headerlink" title="5.1 BlockingQueue"></a>5.1 BlockingQueue</h3><p>一个线程将会持续生产新对象并将其插入到队列之中，直到队列达到它所能容纳的临界点</p>
<p>也就是说，它是有限的，如果该阻塞队列到达了其临界点，负责生产的线程将会在往里边插入新对象时发生阻塞，直到负责消费的线程从队列中拿走一个对象。</p>
<p>负责消费的线程将会一直从该阻塞队列中拿出对象。如果消费线程尝试去从一个空的队列中提取对象的话，这个消费线程将会处于阻塞之中，直到一个生产线程把一个对象丢进队列</p>
<p>常用实现：</p>
<ol>
<li>ArrayBlockingQueue 上限不能改变</li>
<li>LinkedBlockingQueue 上限能改变</li>
<li>DelayQueue 对元素进行持有，直到到期 </li>
<li>PriorityBlockingQueue 排序规则和 java.util.PriorityQueue 相同</li>
<li>SynchronousQueue 只能放一个元素</li>
</ol>
<h3 id="5-2-BlockingDeque"><a href="#5-2-BlockingDeque" class="headerlink" title="5.2 BlockingDeque"></a>5.2 BlockingDeque</h3><p>如果生产者线程需要在队列的两端都可以插入数据，消费者线程需要在队列的两端都可以移除数据，可以使用 BlockingDeque </p>
<p>如果双端队列已满，插入线程将被阻塞，直到一个移除线程从该队列中移出了一个元素</p>
<p>如果双端队列为空，移除线程将被阻塞，直到一个插入线程向该队列插入了一个新元素 </p>
<h3 id="5-3-ConcurrentMap"><a href="#5-3-ConcurrentMap" class="headerlink" title="5.3 ConcurrentMap"></a>5.3 ConcurrentMap</h3><p>见 <a target="_blank" rel="noopener" href="http://www.jasongj.com/java/concurrenthashmap">ConcurrentHashMap演进从Java7到Java8</a> </p>
<h2 id="6-CyclicBarrier"><a href="#6-CyclicBarrier" class="headerlink" title="6. CyclicBarrier"></a>6. CyclicBarrier</h2><p>它就是一个所有线程必须等待的一个栅栏，直到所有线程都到达这里，然后所有线程才可以继续做其他事情 </p>
<h2 id="7-Exchanger"><a href="#7-Exchanger" class="headerlink" title="7. Exchanger"></a>7. Exchanger</h2><p>表示一种两个线程可以进行互相交换对象的会和点 </p>
<h2 id="8-Semaphore"><a href="#8-Semaphore" class="headerlink" title="8. Semaphore"></a>8. Semaphore</h2><p>计数信号量由一个指定数量的 “许可” 初始化</p>
<p>每调用一次 acquire()，一个许可会被调用线程取走。每调用一次 release()，一个许可会被返还给信号量</p>
<p>因此，在没有任何 release() 调用时，最多有 N 个线程能够通过 acquire() 方法，N 是该信号量初始化时的许可的指定数量。 </p>
<h2 id="9-Atomic-Variable"><a href="#9-Atomic-Variable" class="headerlink" title="9. Atomic Variable"></a>9. Atomic Variable</h2><p>java.util.concurrent.atomic 包中定义了对单个变量的原子操作支持</p>
<p>包中的所有的类的 getter 和 setter，都像对 volatile 变量操作一样，具有原子性，即一个set操作与后续的get操作存在绝对的先后关系 </p>
<h3 id="9-1-AtomicReference"><a href="#9-1-AtomicReference" class="headerlink" title="9.1 AtomicReference"></a>9.1 AtomicReference</h3><p>AtomicReference 类具备了一个很有用的方法：compareAndSet()</p>
<p>compareAndSet() 可以将保存在 AtomicReference 里的引用于一个期望引用进行比较，如果两个引用是一样的，将会给 AtomicReference 实例设置一个新的引用 —— <strong>并非 equals() 的相等，而是 &#x3D;&#x3D; 的相等</strong> </p>
<h2 id="10-ThreadLocalRandom"><a href="#10-ThreadLocalRandom" class="headerlink" title="10. ThreadLocalRandom"></a>10. ThreadLocalRandom</h2><p>在并发环境中，使用 ThreadLocalRandom 替换 Math.random() 可以减少冲突，提高性能</p>
<p>可以将它用来在多线程或ForJoinTask中获得随机数</p>
<hr>
<p>参考文章</p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/package-summary.html">java.util.concurrent (Java Platform SE 8 )</a> </p>
<p><a target="_blank" rel="noopener" href="http://623deyingxiong.iteye.com/blog/1754030">高级并发对象(Councurrency Tutorial 7) - 春晓春晓 - ITeye博客</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cz123/p/7693064.html">彻底理解Java的Future模式 - 大诚挚 - 博客园</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/j-jvmc1/index.html">JVM 并发性: Java 和 Scala 并发性基础</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/j-jvmc2/index.html">JVM 并发性: Java 8 并发性基础</a> </p>
<p><a target="_blank" rel="noopener" href="http://ifeve.com/java-fork-join-framework">Java Fork&#x2F;Join框架 | 并发编程网 – ifeve.com</a> </p>
<p><a target="_blank" rel="noopener" href="http://www.importnew.com/26461.html">Java 并发工具包 java.util.concurrent 用户指南 - CSDN博客</a> </p>
<p><a target="_blank" rel="noopener" href="http://www.jasongj.com/java/concurrenthashmap">ConcurrentHashMap演进从Java7到Java8 | 技术世界</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2018-08-10-Java%E7%9A%84IO.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018-08-10-Java%E7%9A%84IO.html" class="post-title-link" itemprop="url">Java的IO</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-08-10 20:41:02" itemprop="dateCreated datePublished" datetime="2018-08-10T20:41:02+08:00">2018-08-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-08-13 20:44:12" itemprop="dateModified" datetime="2018-08-13T20:44:12+08:00">2018-08-13</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>15k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>14 分钟</span>
    </span>
</div>

            <div class="post-description">Java 的 I/O 库介绍，其中重点介绍了 NIO 部分在 server 端的应用</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-I-x2F-O-类库概况"><a href="#Java-I-x2F-O-类库概况" class="headerlink" title="Java I&#x2F;O 类库概况"></a>Java I&#x2F;O 类库概况</h1><p>Java 的 I&#x2F;O 操作类在包 java.io 下，大概有将近 80 个类，但是这些类大概可以分成四组，分别是： </p>
<ol>
<li>基于字节操作的 I&#x2F;O 接口：InputStream 和 OutputStream</li>
<li>基于字符操作的 I&#x2F;O 接口：Writer 和 Reader</li>
<li>基于磁盘操作的 I&#x2F;O 接口：File</li>
<li>基于网络操作的 I&#x2F;O 接口：Socket</li>
</ol>
<h1 id="字节与字符的转化接口"><a href="#字节与字符的转化接口" class="headerlink" title="字节与字符的转化接口"></a>字节与字符的转化接口</h1><h3 id="InputStreamReader"><a href="#InputStreamReader" class="headerlink" title="InputStreamReader"></a>InputStreamReader</h3><p>InputStreamReader 类是字节到字符的转化桥梁，InputStream 到 Reader 的过程要指定编码字符集，否则将采用操作系统默认字符集</p>
<p>StreamDecoder 正是完成字节到字符的解码的实现类</p>
<h3 id="OutputStreamWriter"><a href="#OutputStreamWriter" class="headerlink" title="OutputStreamWriter"></a>OutputStreamWriter</h3><p>OutputStreamWriter 类完成，字符到字节的编码过程，由 StreamEncoder 完成编码过程 </p>
<h1 id="磁盘-I-x2F-O-工作机制"><a href="#磁盘-I-x2F-O-工作机制" class="headerlink" title="磁盘 I&#x2F;O 工作机制"></a>磁盘 I&#x2F;O 工作机制</h1><p><img src="https://www.ibm.com/developerworks/cn/java/j-lo-javaio/image015.jpg" alt="磁盘 I/O"> </p>
<h1 id="Java-Socket-的工作机制"><a href="#Java-Socket-的工作机制" class="headerlink" title="Java Socket 的工作机制"></a>Java Socket 的工作机制</h1><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>Socket 这个概念没有对应到一个具体的实体，它是描述计算机之间完成相互通信一种抽象功能</p>
<p>打个比方，可以把 Socket 比作为两个城市之间的交通工具，有了它，就可以在城市之间来回穿梭；交通工具有多种，每种交通工具也有相应的交通规则</p>
<p>Socket 也一样，也有多种：大部分情况下我们使用的都是基于 TCP&#x2F;IP 的流套接字，它是一种稳定的通信协议</p>
<h3 id="建立通信链路-client"><a href="#建立通信链路-client" class="headerlink" title="建立通信链路 - client"></a>建立通信链路 - client</h3><p>当客户端要与服务端通信，客户端首先要创建一个 Socket 实例，操作系统将为这个 Socket 实例分配一个没有被使用的本地端口号，并创建一个包含本地和远程地址和端口号的套接字数据结构，这个数据结构将一直保存在系统中直到这个连接关闭</p>
<p>在创建 Socket 实例的构造函数正确返回之前，将要进行 TCP 的三次握手协议，TCP 握手协议完成后，Socket 实例对象将创建完成，否则将抛出 IOException 错误 </p>
<h3 id="建立通信链路-server"><a href="#建立通信链路-server" class="headerlink" title="建立通信链路 - server"></a>建立通信链路 - server</h3><p>与之对应的服务端将创建一个 ServerSocket 实例，ServerSocket 创建比较简单只要指定的端口号没有被占用，一般实例创建都会成功，同时操作系统也会为 ServerSocket 实例创建一个底层数据结构，这个数据结构中包含指定监听的端口号和包含监听地址的通配符，通常情况下都是“*”即监听所有地址</p>
<p>之后当调用 accept() 方法时，将进入阻塞状态，等待客户端的请求。当一个新的请求到来时，将为这个连接创建一个新的套接字数据结构，该套接字数据的信息包含的地址和端口信息正是请求源地址和端口</p>
<p>这个新创建的数据结构将会关联到 ServerSocket 实例的一个未完成的连接数据结构列表中，注意这时服务端与之对应的 Socket 实例并没有完成创建，而要等到与客户端的三次握手完成后，这个服务端的 Socket 实例才会返回，并将这个 Socket 实例对应的数据结构从未完成列表中移到已完成列表中</p>
<p>所以 ServerSocket 所关联的列表中每个数据结构，都代表与一个客户端的建立的 TCP 连接 </p>
<h3 id="数据传输"><a href="#数据传输" class="headerlink" title="数据传输"></a>数据传输</h3><p>当连接已经建立成功，服务端和客户端都会拥有一个 Socket 实例，每个 Socket 实例都有一个 InputStream 和 OutputStream，正是通过这两个对象来交换数据</p>
<p>当 Socket 对象创建时，操作系统将会为 InputStream 和 OutputStream 分别分配一定大小的缓冲区，数据的写入和读取都是通过这个缓存区完成的</p>
<p>写入端将数据写到 OutputStream 对应的 SendQ 队列中，当队列填满时，数据将被发送到另一端 InputStream 的 RecvQ 队列中 </p>
<h1 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h1><p><img src="https://www.ibm.com/developerworks/cn/java/j-lo-javaio/image019.jpg" alt="NIO"> </p>
<h3 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h3><p>通道是对原 I&#x2F;O 包中的流的模拟，到任何目的地(或来自任何地方)的所有数据都必须通过一个 Channel 对象 </p>
<p>拿 NIO 与原来的 I&#x2F;O 做个比较，通道就像是流。通道与流的不同之处在于通道是双向的，而流只是在一个方向上移动（一个流必须是 <code>InputStream</code> 或者 <code>OutputStream</code> 的子类）， 而  <code>通道 </code> 可以用于读、写或者同时用于读写 </p>
<p>正如前面提到的，所有数据都通过 <code>Buffer</code> 对象来处理。您永远不会将字节直接写入通道中，相反，您是将数据写入包含一个或者多个字节的缓冲区。同样，您不会直接从通道中读取字节，而是将数据从通道读入缓冲区，再从缓冲区获取这个字节</p>
<h3 id="selector"><a href="#selector" class="headerlink" title="selector"></a>selector</h3><p>Selector 可以比作为一个车站的车辆运行调度系统，它将负责监控每辆车的当前运行状态：是已经出战还是在路上等等，也就是它可以轮询每个 Channel 的状态 </p>
<h3 id="buffer"><a href="#buffer" class="headerlink" title="buffer"></a>buffer</h3><p><code>Buffer</code> 是一个对象， 它包含一些要写入或者刚读出的数据。 在 NIO 中加入 <code>Buffer</code> 对象，体现了新库与原 I&#x2F;O 的一个重要区别。在面向流的 I&#x2F;O 中，您将数据直接写入或者将数据直接读到 <code>Stream</code> 对象中。</p>
<p>在 NIO 库中，所有数据都是用缓冲区处理的：在读取数据时，它是直接读到缓冲区中的；在写入数据时，它是写入到缓冲区中的。任何时候访问 NIO 中的数据，您都是将它放到缓冲区中</p>
<p>缓冲区实质上是一个数组。通常它是一个字节数组，但是也可以使用其他种类的数组。但是一个缓冲区不 <em>仅仅</em>  是一个数组。缓冲区提供了对数据的结构化访问，而且还可以跟踪系统的读&#x2F;写进程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// io 与 nio 比较</span></span><br><span class="line">FileInputStream fis;</span><br><span class="line"><span class="comment">// io</span></span><br><span class="line">fis = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;in&quot;</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> fis.read();</span><br><span class="line"><span class="keyword">while</span> (temp != -<span class="number">1</span>) &#123;</span><br><span class="line">    System.out.printf(<span class="string">&quot;%c&quot;</span>, temp);</span><br><span class="line">    temp = fis.read();</span><br><span class="line">&#125;</span><br><span class="line">fis.close();</span><br><span class="line"><span class="comment">// nio</span></span><br><span class="line">fis = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;in&quot;</span>);</span><br><span class="line"><span class="type">FileChannel</span> <span class="variable">fc</span> <span class="operator">=</span> fis.getChannel();</span><br><span class="line"><span class="type">ByteBuffer</span> <span class="variable">bb</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">32</span>);</span><br><span class="line">fc.read(bb);</span><br><span class="line"><span class="type">byte</span>[] array = bb.array();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">byte</span> b : array) &#123;</span><br><span class="line">    System.out.printf(<span class="string">&quot;%c&quot;</span>, b);</span><br><span class="line">&#125;</span><br><span class="line">fis.close();</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// copy file</span></span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">inStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;in.txt&quot;</span>);</span><br><span class="line"><span class="type">FileOutputStream</span> <span class="variable">outStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;out.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">FileChannel</span> <span class="variable">inChannel</span> <span class="operator">=</span> inStream.getChannel();</span><br><span class="line"><span class="type">FileChannel</span> <span class="variable">outChannel</span> <span class="operator">=</span> outStream.getChannel();</span><br><span class="line"></span><br><span class="line"><span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">flag</span> <span class="operator">=</span> inChannel.read(buffer);</span><br><span class="line">    <span class="keyword">if</span> (flag == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    buffer.flip();</span><br><span class="line">    outChannel.write(buffer);</span><br><span class="line">    buffer.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NIO 引入了 Channel、Buffer 和 Selector 就是想把这些信息具体化，让程序员有机会控制它们，如：当我们调用 write() 往 SendQ 写数据时，当一次写的数据超过 SendQ 长度时需要按照 SendQ 的长度进行分割，这个过程中需要有将用户空间数据和内核地址空间进行切换，而这个切换不是你可以控制的；而在 Buffer 中我们可以控制 Buffer 的 capacity，并且是否扩容以及如何扩容都可以控制 </p>
<h3 id="buffer-的状态变量"><a href="#buffer-的状态变量" class="headerlink" title="buffer 的状态变量"></a>buffer 的状态变量</h3><p>可以用三个值指定缓冲区在任意时刻的状态，这三个变量一起可以跟踪缓冲区的状态和它所包含的数据：</p>
<ul>
<li><code>position</code></li>
<li><code>limit</code></li>
<li><code>capacity</code></li>
</ul>
<p>相关详细：<a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/education/java/j-nio/j-nio.html">NIO 入门</a></p>
<h3 id="buffer-的访问方法"><a href="#buffer-的访问方法" class="headerlink" title="buffer 的访问方法"></a>buffer 的访问方法</h3><h5 id="缓存区分配和包装"><a href="#缓存区分配和包装" class="headerlink" title="缓存区分配和包装"></a>缓存区分配和包装</h5><ul>
<li>ByteBuffer.allocate( 1024 ) : ByteBuffer</li>
<li>ByteBuffer.wrap( new byte[1024] ) : ByteBuffer</li>
</ul>
<h5 id="读写"><a href="#读写" class="headerlink" title="读写"></a>读写</h5><p>您可能需要将用户数据保存到磁盘。在这种情况下，您必须将这些数据直接放入缓冲区，然后用通道将缓冲区写入磁盘</p>
<p>或者，您可能想要从磁盘读取用户数据。在这种情况下，您要将数据从通道读到缓冲区中，然后检查缓冲区中的数据</p>
<ul>
<li>get()</li>
<li>put()</li>
</ul>
<h5 id="缓存区分片"><a href="#缓存区分片" class="headerlink" title="缓存区分片"></a>缓存区分片</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buffer.position( <span class="number">3</span> );</span><br><span class="line">buffer.limit( <span class="number">7</span> );</span><br><span class="line"><span class="type">ByteBuffer</span> <span class="variable">slice</span> <span class="operator">=</span> buffer.slice();</span><br></pre></td></tr></table></figure>

<h5 id="只读缓冲区"><a href="#只读缓冲区" class="headerlink" title="只读缓冲区"></a>只读缓冲区</h5><ul>
<li>byteByffer.asReadOnlyBuffer()</li>
</ul>
<h3 id="零拷贝"><a href="#零拷贝" class="headerlink" title="零拷贝"></a>零拷贝</h3><p>Java NIO 中提供的 FileChannel 拥有 transferTo() 和 transferFrom() 两个方法，可直接把 FileChannel() 中的数据拷贝到另外一个 Channel，或者直接把另外一个 Channel 中的数据拷贝到 FileChannel </p>
<p>该接口常被用于高效的网络&#x2F;文件的数据传输和大文件拷贝：在操作系统支持的情况下，通过该方法传输数据并不需要将源数据从内核态拷贝到用户态，再从用户态拷贝到目标通道的内核态，同时也避免了两次用户态和内核态间的上下文切换，也即使用了“零拷贝”，所以其性能一般高于Java IO中提供的方法 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> SocketChannel.open();</span><br><span class="line">        <span class="type">InetSocketAddress</span> <span class="variable">address</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">1234</span>);</span><br><span class="line">        socketChannel.connect(address);</span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(</span><br><span class="line">                NIOClient.class.getClassLoader().getResource(<span class="string">&quot;test.txt&quot;</span>).getFile(), <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> file.getChannel();</span><br><span class="line">        channel.transferTo(<span class="number">0</span>, channel.size(), socketChannel);</span><br><span class="line">        channel.close();</span><br><span class="line">        file.close();</span><br><span class="line">        socketChannel.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="同步、异步、阻塞、非阻塞"><a href="#同步、异步、阻塞、非阻塞" class="headerlink" title="同步、异步、阻塞、非阻塞"></a>同步、异步、阻塞、非阻塞</h1><h3 id="同步与异步"><a href="#同步与异步" class="headerlink" title="同步与异步"></a>同步与异步</h3><p>所谓同步就是一个任务的完成需要依赖另外一个任务时，只有等待被依赖的任务完成后，依赖的任务才能算完成，这是一种可靠的任务序列：要么成功都成功，失败都失败，两个任务的状态可以保持一致</p>
<p>而异步是不需要等待被依赖的任务完成，只是通知被依赖的任务要完成什么工作，依赖的任务也立即执行，只要自己完成了整个任务就算完成了。至于被依赖的任务最终是否真正完成，依赖它的任务无法确定，所以它是不可靠的任务序列</p>
<p>我们可以用打电话和发短信来很好的比喻同步与异步操作</p>
<p>在设计到 IO 处理时通常都会遇到一个是同步还是异步的处理方式的选择问题。因为同步与异步的 I&#x2F;O 处理方式对调用者的影响很大，在数据库产品中都会遇到这个问题。因为 I&#x2F;O 操作通常是一个非常耗时的操作，在一个任务序列中 I&#x2F;O 通常都是性能瓶颈。但是同步与异步的处理方式对程序的可靠性影响非常大，同步能够保证程序的可靠性，而异步可以提升程序的性能，必须在可靠性和性能之间做个平衡，没有完美的解决办法。</p>
<h3 id="阻塞与非阻塞"><a href="#阻塞与非阻塞" class="headerlink" title="阻塞与非阻塞"></a>阻塞与非阻塞</h3><p>阻塞与非阻塞主要是从 CPU 的消耗上来说的，阻塞就是 CPU 停下来等待一个慢的操作完成 CPU 才接着完成其它的事</p>
<p>非阻塞就是在这个慢的操作在执行时 CPU 去干其它别的事，等这个慢的操作完成时，CPU 再接着完成后续的操作</p>
<p>虽然表面上看非阻塞的方式可以明显的提高 CPU 的利用率，但是也带了另外一种后果就是系统的线程切换增加：增加的 CPU 使用时间能不能补偿系统的切换成本需要好好评估</p>
<h3 id="两种的方式的组合"><a href="#两种的方式的组合" class="headerlink" title="两种的方式的组合"></a>两种的方式的组合</h3><table>
<thead>
<tr>
<th><strong>组合方式</strong></th>
<th><strong>性能分析</strong></th>
</tr>
</thead>
<tbody><tr>
<td>同步阻塞</td>
<td>最常用的一种用法，使用也是最简单的，但是 I&#x2F;O 性能一般很差，CPU 大部分在空闲状态。</td>
</tr>
<tr>
<td>同步非阻塞</td>
<td>提升 I&#x2F;O 性能的常用手段，就是将 I&#x2F;O 的阻塞改成非阻塞方式，尤其在网络 I&#x2F;O 是长连接，同时传输数据也不是很多的情况下，提升性能非常有效。这种方式通常能提升 I&#x2F;O 性能，但是会增加 CPU 消耗，要考虑增加的 I&#x2F;O 性能能不能补偿 CPU 的消耗，也就是系统的瓶颈是在 I&#x2F;O 还是在 CPU 上。</td>
</tr>
<tr>
<td>异步阻塞</td>
<td>这种方式在分布式数据库中经常用到，例如在往一个分布式数据库中写一条记录，通常会有一份是同步阻塞的记录，而还有两至三份是备份记录会写到其它机器上，这些备份记录通常都是采用异步阻塞的方式写 I&#x2F;O。 异步阻塞对网络 I&#x2F;O 能够提升效率，尤其像上面这种同时写多份相同数据的情况。</td>
</tr>
<tr>
<td>异步非阻塞</td>
<td>这种组合方式用起来比较复杂，只有在一些非常复杂的分布式情况下使用，像集群之间的消息同步机制一般用这种 I&#x2F;O 组合方式。如 Cassandra 的 Gossip 通信机制就是采用异步非阻塞的方式。 它适合同时要传多份相同的数据到集群中不同的机器，同时数据的传输量虽然不大，但是却非常频繁。这种网络 I&#x2F;O 用这个方式性能能达到最高。</td>
</tr>
</tbody></table>
<h1 id="server和异步IO"><a href="#server和异步IO" class="headerlink" title="server和异步IO"></a>server和异步IO</h1><h3 id="server-实现"><a href="#server-实现" class="headerlink" title="server 实现"></a>server 实现</h3><ul>
<li>Java I&#x2F;O，单线程：循环处理请求——同一时间只能处理一个请求，等待I&#x2F;O的过程浪费大量CPU资源，同时无法充分使用多CPU的优势 </li>
<li>Java I&#x2F;O，多线程：为每个请求创建一个线程；为了防止连接请求过多，导致服务器创建的线程数过多，造成过多线程上下文切换的开销，可以通过线程池来限制创建的线程数 </li>
<li>Java NIO，单线程：经典 Reactor 模式——所有读&#x2F;写请求以及对新连接请求的处理都在同一个线程中处理，无法充分利用多CPU的优势，同时读&#x2F;写操作也会阻塞对新连接请求的处理 </li>
<li>Java NIO，多线程：多工作线程 Reactor 模式</li>
<li>Java NIO，多线程：多 Reactor 模式</li>
</ul>
<h3 id="经典-Reactor-模式"><a href="#经典-Reactor-模式" class="headerlink" title="经典 Reactor 模式"></a>经典 Reactor 模式</h3><p>在Reactor模式中，包含如下角色</p>
<ul>
<li><strong>Reactor</strong> 将I&#x2F;O事件发派给对应的Handler</li>
<li><strong>Acceptor</strong> 处理客户端连接请求</li>
<li><strong>Handlers</strong> 执行非阻塞读&#x2F;写</li>
</ul>
<p><img src="http://www.jasongj.com/img/java/reactor/classic_reactor.png" alt="经典 Reactor 模式"> </p>
<p>调用 Selector 的静态工厂创建一个选择器，创建一个服务端的 Channel 绑定到一个 Socket 对象，并把这个通信信道注册到选择器上，把这个通信信道设置为非阻塞模式</p>
<p>然后就可以调用 Selector 的 selectedKeys 方法来检查已经注册在这个选择器上的所有通信信道是否有需要的事件发生，如果有某个事件发生时，将会返回所有的 SelectionKey，通过这个对象 Channel 方法就可以取得这个通信信道对象从而可以读取通信的数据，而这里读取的数据是 Buffer，这个 Buffer 是我们可以控制的缓冲器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOServer</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(NIOServer.class);</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">    <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">    serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">    serverSocketChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">1234</span>));</span><br><span class="line">    serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">    <span class="keyword">while</span> (selector.select() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">      Iterator&lt;SelectionKey&gt; iterator = keys.iterator();</span><br><span class="line">      <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">        <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        iterator.remove();</span><br><span class="line">        <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">          <span class="type">ServerSocketChannel</span> <span class="variable">acceptServerSocketChannel</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">          <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> acceptServerSocketChannel.accept();</span><br><span class="line">          socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">          LOGGER.info(<span class="string">&quot;Accept request from &#123;&#125;&quot;</span>, socketChannel.getRemoteAddress());</span><br><span class="line">          socketChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">          <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">          <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">          <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> socketChannel.read(buffer);</span><br><span class="line">          <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            socketChannel.close();</span><br><span class="line">            key.cancel();</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Received invalide data, close the connection&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          LOGGER.info(<span class="string">&quot;Received message &#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array()));</span><br><span class="line">        &#125;</span><br><span class="line">        keys.remove(key);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上示代码中可以看到，多个Channel可以注册到同一个Selector对象上，实现了一个线程同时监控多个请求状态(channel)</p>
<p>同时注册时需要指定它所关注的事件，例如上示代码中 <em>socketServerChannel</em> 对象只注册了 <em>OP_ACCEPT</em> 事件，而 <em>socketChannel</em> 对象只注册了 <em>OP_READ</em> 事件</p>
<p><code>selector.select()</code> 是阻塞的，当有至少一个通道可用时该方法返回可用通道个数。同时该方法只捕获Channel注册时指定的所关注的事件 </p>
<h3 id="多工作线程Reactor模式"><a href="#多工作线程Reactor模式" class="headerlink" title="多工作线程Reactor模式"></a>多工作线程Reactor模式</h3><p>经典Reactor模式中，尽管一个线程可同时监控多个请求(channel)，但是所有读&#x2F;写请求以及对新连接请求的处理都在同一个线程中处理，无法充分利用多CPU的优势，同时读&#x2F;写操作也会阻塞对新连接请求的处理；因此可以引入多线程，并行处理多个读&#x2F;写操作 </p>
<p><img src="http://www.jasongj.com/img/java/reactor/multithread_reactor.png" alt="多工作线程Reactor模式"> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOServer</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(NIOServer.class);</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">    <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">    serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">    serverSocketChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">1234</span>));</span><br><span class="line">    serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span>(selector.selectNow() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">      Iterator&lt;SelectionKey&gt; iterator = keys.iterator();</span><br><span class="line">      <span class="keyword">while</span>(iterator.hasNext()) &#123;</span><br><span class="line">        <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        iterator.remove();</span><br><span class="line">        <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">          <span class="type">ServerSocketChannel</span> <span class="variable">acceptServerSocketChannel</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">          <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> acceptServerSocketChannel.accept();</span><br><span class="line">          socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">          LOGGER.info(<span class="string">&quot;Accept request from &#123;&#125;&quot;</span>, socketChannel.getRemoteAddress());</span><br><span class="line">          <span class="type">SelectionKey</span> <span class="variable">readKey</span> <span class="operator">=</span> socketChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">          readKey.attach(<span class="keyword">new</span> <span class="title class_">Processor</span>());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">          <span class="type">Processor</span> <span class="variable">processor</span> <span class="operator">=</span> (Processor) key.attachment();</span><br><span class="line">          processor.process(key);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上示代码中可以看到，注册完 SocketChannel 的 <em>OP_READ</em> 事件后，可以对相应的 SelectionKey attach 一个对象（本例中 attach 了一个 Processor 对象，该对象处理读请求），并且在获取到可读事件后，可以取出该对象</p>
<p>注：attach对象及取出该对象是 NIO 提供的一种操作，但该操作并非 Reactor 模式的必要操作，本文使用它，只是为了方便演示NIO的接口</p>
<p>具体的读请求处理在如下所示的 Processor 类中。该类中设置了一个静态的线程池处理所有请求。而 <em>process</em> 方法并不直接处理 I&#x2F;O 请求，而是把该 I&#x2F;O 操作提交给上述线程池去处理，这样就充分利用了多线程的优势，同时将对新连接的处理和读&#x2F;写操作的处理放在了不同的线程中，读&#x2F;写操作不再阻塞对新连接请求的处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Processor</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(Processor.class);</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(SelectionKey selectionKey)</span> &#123;</span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">      <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">      <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> (SocketChannel) selectionKey.channel();</span><br><span class="line">      <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> socketChannel.read(buffer);</span><br><span class="line">      <span class="keyword">if</span> (count &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        socketChannel.close();</span><br><span class="line">        selectionKey.cancel();</span><br><span class="line">        LOGGER.info(<span class="string">&quot;&#123;&#125;\t Read ended&quot;</span>, socketChannel);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      LOGGER.info(<span class="string">&quot;&#123;&#125;\t Read message &#123;&#125;&quot;</span>, socketChannel, <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array()));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="多Reactor"><a href="#多Reactor" class="headerlink" title="多Reactor"></a>多Reactor</h3><p>Netty中使用的Reactor模式，引入了多Reactor，也即一个主Reactor负责监控所有的连接请求，多个子Reactor负责监控并处理读&#x2F;写请求，减轻了主Reactor的压力，降低了主Reactor压力太大而造成的延迟</p>
<p>并且每个子Reactor分别属于一个独立的线程，每个成功连接后的Channel的所有操作由同一个线程处理，这样保证了同一请求的所有状态和上下文在同一个线程中，避免了不必要的上下文切换，同时也方便了监控请求响应状态 </p>
<p><img src="http://www.jasongj.com/img/java/reactor/multi_reactor.png" alt="多Reactor"> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOServer</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(NIOServer.class);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">    <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">    serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">    serverSocketChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">1234</span>));</span><br><span class="line">    serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">coreNum</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">    Processor[] processors = <span class="keyword">new</span> <span class="title class_">Processor</span>[coreNum];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; processors.length; i++) &#123;</span><br><span class="line">      processors[i] = <span class="keyword">new</span> <span class="title class_">Processor</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (selector.select() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">      <span class="keyword">for</span> (SelectionKey key : keys) &#123;</span><br><span class="line">        keys.remove(key);</span><br><span class="line">        <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">          <span class="type">ServerSocketChannel</span> <span class="variable">acceptServerSocketChannel</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">          <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> acceptServerSocketChannel.accept();</span><br><span class="line">          socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">          LOGGER.info(<span class="string">&quot;Accept request from &#123;&#125;&quot;</span>, socketChannel.getRemoteAddress());</span><br><span class="line">          <span class="type">Processor</span> <span class="variable">processor</span> <span class="operator">=</span> processors[(<span class="type">int</span>) ((index++) % coreNum)];</span><br><span class="line">          processor.addChannel(socketChannel);</span><br><span class="line">          processor.wakeup();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上代码所示，本文设置的子 Reactor 个数是当前机器可用核数的两倍（与 Netty 默认的子 Reactor 个数一致）</p>
<p>对于每个成功连接的 SocketChannel，通过 round robin 的方式交给不同的子 Reactor </p>
<p>子 Reactor 对 SocketChannel 的处理如下所示 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Processor</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(Processor.class);</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span></span><br><span class="line">      Executors.newFixedThreadPool(<span class="number">2</span> * Runtime.getRuntime().availableProcessors());</span><br><span class="line">  <span class="keyword">private</span> Selector selector;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Processor</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="built_in">this</span>.selector = SelectorProvider.provider().openSelector();</span><br><span class="line">    start();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> ClosedChannelException &#123;</span><br><span class="line">    socketChannel.register(<span class="built_in">this</span>.selector, SelectionKey.OP_READ);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wakeup</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.selector.wakeup();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (selector.select(<span class="number">500</span>) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">        Iterator&lt;SelectionKey&gt; iterator = keys.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">          <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">          iterator.remove();</span><br><span class="line">          <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> socketChannel.read(buffer);</span><br><span class="line">            <span class="keyword">if</span> (count &lt; <span class="number">0</span>) &#123;</span><br><span class="line">              socketChannel.close();</span><br><span class="line">              key.cancel();</span><br><span class="line">              LOGGER.info(<span class="string">&quot;&#123;&#125;\t Read ended&quot;</span>, socketChannel);</span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">              LOGGER.info(<span class="string">&quot;&#123;&#125;\t Message size is 0&quot;</span>, socketChannel);</span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              LOGGER.info(<span class="string">&quot;&#123;&#125;\t Read message &#123;&#125;&quot;</span>, socketChannel, <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array()));</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Processor中，同样创建了一个静态的线程池，且线程池的大小为机器核数的两倍</p>
<p>每个Processor实例均包含一个Selector实例，同时每次获取Processor实例时均提交一个任务到该线程池，并且该任务正常情况下一直循环处理，不会停止</p>
<p>而提交给该Processor的SocketChannel通过在其Selector注册事件，加入到相应的任务中，由此实现了每个子Reactor包含一个Selector对象，并由一个独立的线程处理 </p>
<h1 id="I-x2F-O-调优"><a href="#I-x2F-O-调优" class="headerlink" title="I&#x2F;O 调优"></a>I&#x2F;O 调优</h1><h3 id="磁盘-I-x2F-O-优化"><a href="#磁盘-I-x2F-O-优化" class="headerlink" title="磁盘 I&#x2F;O 优化"></a>磁盘 I&#x2F;O 优化</h3><p>提升磁盘 I&#x2F;O 性能通常的方法有：</p>
<ol>
<li>增加缓存，减少磁盘访问次数</li>
<li>优化磁盘的管理系统，设计最优的磁盘访问策略，以及磁盘的寻址策略，这里是在底层操作系统层面考虑的。</li>
<li>设计合理的磁盘存储数据块，以及访问这些数据块的策略，这里是在应用层面考虑的。如我们可以给存放的数据设计索引，通过寻址索引来加快和减少磁盘的访问，还有可以采用异步和非阻塞的方式加快磁盘的访问效率。</li>
<li>应用合理的 RAID 策略提升磁盘 IO，每种 RAID 的区别我们可以用下表所示：</li>
</ol>
<table>
<thead>
<tr>
<th><strong>磁盘阵列</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>RAID 0</td>
<td>数据被平均写到多个磁盘阵列中，写数据和读数据都是并行的，所以磁盘的 IOPS 可以提高一倍。</td>
</tr>
<tr>
<td>RAID 1</td>
<td>RAID 1 的主要作用是能够提高数据的安全性，它将一份数据分别复制到多个磁盘阵列中。并不能提升 IOPS 但是相同的数据有多个备份。通常用于对数据安全性较高的场合中。</td>
</tr>
<tr>
<td>RAID 5</td>
<td>这中设计方式是前两种的折中方式，它将数据平均写到所有磁盘阵列总数减一的磁盘中，往另外一个磁盘中写入这份数据的奇偶校验信息。如果其中一个磁盘损坏，可以通过其它磁盘的数据和这个数据的奇偶校验信息来恢复这份数据。</td>
</tr>
<tr>
<td>RAID 0+1</td>
<td>如名字一样，就是根据数据的备份情况进行分组，一份数据同时写到多个备份磁盘分组中，同时多个分组也会并行读写。</td>
</tr>
</tbody></table>
<h3 id="网络-I-x2F-O-优化"><a href="#网络-I-x2F-O-优化" class="headerlink" title="网络 I&#x2F;O 优化"></a>网络 I&#x2F;O 优化</h3><p>网络 I&#x2F;O 优化通常有一些基本处理原则：</p>
<ol>
<li>一个是减少网络交互的次数：要减少网络交互的次数通常我们在需要网络交互的两端会设置缓存，比如 Oracle 的 JDBC 驱动程序，就提供了对查询的 SQL 结果的缓存，在客户端和数据库端都有，可以有效的减少对数据库的访问</li>
<li>除了设置缓存还有一个办法是，合并访问请求：如在查询数据库时，我们要查 10 个 id，我可以每次查一个 id，也可以一次查 10 个 id。再比如在访问一个页面时通过会有多个 js 或 css 的文件，我们可以将多个 js 文件合并在一个 HTTP 链接中，每个文件用逗号隔开，然后发送到后端 Web 服务器根据这个 URL 链接，再拆分出各个文件，然后打包再一并发回给前端浏览器。这些都是常用的减少网络 I&#x2F;O 的办法</li>
<li>减少网络传输数据量的大小：减少网络数据量的办法通常是将数据压缩后再传输，如 HTTP 请求中，通常 Web 服务器将请求的 Web 页面 gzip 压缩后在传输给浏览器。还有就是通过设计简单的协议，尽量通过读取协议头来获取有用的价值信息。比如在代理程序设计时，有 4 层代理和 7 层代理都是来尽量避免要读取整个通信数据来取得需要的信息。</li>
<li>尽量减少编码：通常在网络 I&#x2F;O 中数据传输都是以字节形式的，也就是通常要序列化。但是我们发送要传输的数据都是字符形式的，从字符到字节必须编码。但是这个编码过程是比较耗时的，所以在要经过网络 I&#x2F;O 传输时，尽量直接以字节形式发送。也就是尽量提前将字符转化为字节，或者减少字符到字节的转化过程</li>
<li>根据应用场景设计合适的交互方式：主要包括同步与异步阻塞与非阻塞方式</li>
</ol>
<hr>
<p>参考资料</p>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/j-lo-javaio/index.html">深入分析 Java I&#x2F;O 的工作机制</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/education/java/j-nio/j-nio.html">NIO 入门</a> </p>
<p><a target="_blank" rel="noopener" href="http://www.jasongj.com/java/nio_reactor">NIO Reactor I&#x2F;O模型 | 技术世界</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2018-08-08-%E4%B8%89%E7%A7%8D%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018-08-08-%E4%B8%89%E7%A7%8D%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98.html" class="post-title-link" itemprop="url">三种背包问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-08-08 00:40:47" itemprop="dateCreated datePublished" datetime="2018-08-08T00:40:47+08:00">2018-08-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-08-13 20:51:40" itemprop="dateModified" datetime="2018-08-13T20:51:40+08:00">2018-08-13</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

            <div class="post-description">动态规划的经典问题</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背包九-三-讲"><a href="#背包九-三-讲" class="headerlink" title="背包九(三)讲"></a>背包九(三)讲</h1><h2 id="1-01背包"><a href="#1-01背包" class="headerlink" title="1. 01背包"></a>1. 01背包</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>有 N 件物品和一个容量为 S 的背包。第 i 件物品的费用是 c[i]，价值是 v[i]。求解将哪些物品装入背包可使这些物品的费用总和不超过背包容量，且价值总和最大。</p>
<h3 id="状态方程"><a href="#状态方程" class="headerlink" title="状态方程"></a>状态方程</h3><p>$$<br>state[i][v] &#x3D; max { state[i-1][v], state[i-1][v-c[i]]+v[i] }<br>$$</p>
<p>state[i][v]：只使用前 i 件物品，总花费刚好为 v 时的总价值</p>
<p>若包括第 i 个物品，则 state[i][v] &#x3D; state[i-1][v-c[i]] + v[i]</p>
<p>若不包括第 i 个物品，则 state[i][v] &#x3D; state[i-1][v]</p>
<p>最后要遍历 state[N-1][v], 最大的值即为答案</p>
<h3 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h3><p>时间复杂度：O(NS)</p>
<p>空间复杂度：O(NS)</p>
<h3 id="优化后的状态方程"><a href="#优化后的状态方程" class="headerlink" title="优化后的状态方程"></a>优化后的状态方程</h3><p>观察状态方程，state[i] 只用到了state[i-1] 的数据，可以压缩行数，相当于用 state[i] 的值覆盖 state[i-1]的值<br>$$<br>state[v] &#x3D; max { state[v], state[v-c[i]]+v[i] }<br>$$<br>还是 i 从 0 到 N-1 遍历，只是 v 要从 S 到 0 遍历，在更新时前面的值对应 i-1 时的情况</p>
<p>最后要遍历 state[v]， 最大的值即为答案</p>
<h3 id="优化后的复杂度"><a href="#优化后的复杂度" class="headerlink" title="优化后的复杂度"></a>优化后的复杂度</h3><p>时间复杂度：O(NS)</p>
<p>空间复杂度：O(S)</p>
<h2 id="2-完全背包问题"><a href="#2-完全背包问题" class="headerlink" title="2. 完全背包问题"></a>2. 完全背包问题</h2><h3 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h3><p>有 N 种物品和一个容量为 S 的背包，每种物品都有无限件可用。第 i 种物品的费用是 c[i]，价值是 w[i]。求解将哪些物品装入背包可使这些物品的费用总和不超过背包容量，且价值总和最大。</p>
<h3 id="状态方程-1"><a href="#状态方程-1" class="headerlink" title="状态方程"></a>状态方程</h3><p>$$<br>state[i][v] &#x3D; max { state[i-1][v-k<em>c[i]]+k</em>v[i] | 0 &lt;&#x3D; k*c[i] &lt;&#x3D; v }<br>$$</p>
<p>$$<br>state[i][v] &#x3D; max { state[i-1][v], state[i][v-c[i]]+v[i] }<br>$$</p>
<p>tips：删掉这样的物品 a：存在物品 b，满足 c[b] &lt; c[a] 且 w[b]&#x2F;c[b] &gt; w[a]&#x2F;c[a]</p>
<h3 id="复杂度-1"><a href="#复杂度-1" class="headerlink" title="复杂度"></a>复杂度</h3><p>时间复杂度：&gt;O(NS)</p>
<p>空间复杂度：O(NS)</p>
<h3 id="优化后的状态方程-1"><a href="#优化后的状态方程-1" class="headerlink" title="优化后的状态方程"></a>优化后的状态方程</h3><p>在遍历到 i 的时候，max() 的参数的 state[] 可能已经含有了物品 i<br>$$<br>state[v] &#x3D; max { state[v], state[v-c[i]]+v[i] }<br>$$<br>i 从 0 到 N-1 遍历，v 要从 0 到 S 遍历</p>
<h3 id="优化后的复杂度-1"><a href="#优化后的复杂度-1" class="headerlink" title="优化后的复杂度"></a>优化后的复杂度</h3><p>时间复杂度：O(NS)</p>
<p>空间复杂度：O(S)</p>
<h2 id="3-多重背包问题"><a href="#3-多重背包问题" class="headerlink" title="3. 多重背包问题"></a>3. 多重背包问题</h2><h3 id="问题描述-2"><a href="#问题描述-2" class="headerlink" title="问题描述"></a>问题描述</h3><p>有 N 种物品和一个容量为 S 的背包。第 i 种物品最多有 n[i] 件可用，每件费用是 c[i]，价值是 w[i]。求解将哪些物品装入背包可使这些物品的费用总和不超过背包容量，且价值总和最大。 </p>
<h3 id="状态方程-2"><a href="#状态方程-2" class="headerlink" title="状态方程"></a>状态方程</h3><p>可以把相同的物品当成01背包中不同的物品</p>
<p>转化出新的数组后：<br>$$<br>state[v] &#x3D; max { state[v], state[v-c[i]]+v[i] }<br>$$</p>
<h3 id="复杂度-2"><a href="#复杂度-2" class="headerlink" title="复杂度"></a>复杂度</h3><p>时间复杂度：O( Σn[i]·S)</p>
<p>空间复杂度：O(S)</p>
<h3 id="优化后的状态方程-2"><a href="#优化后的状态方程-2" class="headerlink" title="优化后的状态方程"></a>优化后的状态方程</h3><p>优化前，n[i] 件相同的物品转化成 n[i] 个对应的值</p>
<p>用二进制思想，把 n[i] 件相同的物品转化成 logn[i] 个对应的值</p>
<p>例如，13 个相同的物品转化成 1 个费用 c[i]，价值 w[i] 的物品，加 1 个费用 2*c[i]，价值 2*w[i] 的物品，加 1 个 费用 4*c[i]，价值 4*w[i] 的物品，加 1 个费用 6*c[i]，价值 6*c[i] 的物品</p>
<h3 id="优化后的复杂度-2"><a href="#优化后的复杂度-2" class="headerlink" title="优化后的复杂度"></a>优化后的复杂度</h3><p>时间复杂度：O( Σlogn[i]·S)</p>
<p>空间复杂度：O(S)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2018-07-09-js%E4%B8%AD%E7%9A%84this.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018-07-09-js%E4%B8%AD%E7%9A%84this.html" class="post-title-link" itemprop="url">js中的this</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-07-09 21:28:00" itemprop="dateCreated datePublished" datetime="2018-07-09T21:28:00+08:00">2018-07-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-08-12 21:59:10" itemprop="dateModified" datetime="2018-08-12T21:59:10+08:00">2018-08-12</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

            <div class="post-description">解释几个例子</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="常识"><a href="#常识" class="headerlink" title="常识"></a>常识</h1><p>this 的 scope 由函数&#x2F;类分隔</p>
<h1 id="普通函数"><a href="#普通函数" class="headerlink" title="普通函数"></a>普通函数</h1><p>普通函数即用 函数声明 或 函数表达式 定义的函数</p>
<p>把所有函数调用都转换成显式的 <code>call()</code> 调用</p>
<h3 id="Function-Invocation-Pattern"><a href="#Function-Invocation-Pattern" class="headerlink" title="Function Invocation Pattern"></a>Function Invocation Pattern</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">foo</span>(); <span class="comment">// foo.call(undefined);</span></span><br></pre></td></tr></table></figure>

<p>在<strong>默认模式</strong>下当你传的 context 为 undefined 时，默认的 context为Global对象，在<strong>浏览器</strong>中就是window对象</p>
<p>在<strong>strict模式</strong>下此时 this 即为 undefined</p>
<h3 id="Method-Invocation-Pattern"><a href="#Method-Invocation-Pattern" class="headerlink" title="Method Invocation Pattern"></a>Method Invocation Pattern</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  <span class="attr">foo</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line">obj.<span class="title function_">foo</span>(); <span class="comment">// obj.foo.call(obj)</span></span><br></pre></td></tr></table></figure>

<h3 id="Constructor-Pattern"><a href="#Constructor-Pattern" class="headerlink" title="Constructor Pattern"></a>Constructor Pattern</h3><p>foo函数内部的this永远是new foo()返回的对象 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> c = <span class="keyword">new</span> <span class="keyword">class</span> &#123;</span><br><span class="line">    foo () &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line">c.<span class="title function_">foo</span>(); <span class="comment">// c.foo5.call(c);</span></span><br></pre></td></tr></table></figure>

<h3 id="Apply-Pattern"><a href="#Apply-Pattern" class="headerlink" title="Apply Pattern"></a>Apply Pattern</h3><p>call() 方法的作用和 apply() 方法类似，只有一个区别，就是 call() 方法接受的是若干个<strong>参数的列表</strong>，而 apply() 方法接受的是一个包含多个<strong>参数的数组</strong></p>
<h1 id="箭头函数"><a href="#箭头函数" class="headerlink" title="箭头函数"></a>箭头函数</h1><p>在箭头函数出现之前，每个新定义的函数都有它自己的 <code>this</code> 值，<code>this</code> 被证明是令人厌烦的面向对象风格的编程</p>
<p>在 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Arrow_functions">箭头函数</a> 中，<code>this</code> 与封闭词法上下文的 <code>this</code> 保持一致。 </p>
<p>箭头函数在设计中使用的是Lexical this，即这个函数被创建时的 <code>this</code> 就是函数内部的 <code>this</code></p>
<p>需要注意的是，函数创建时并不是读代码的人第一次肉眼能看到这个函数的时候</p>
<h1 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title function_">foo1</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="keyword">let</span> foo2 = <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>); &#125;;</span><br><span class="line">    <span class="title function_">foo1</span>();</span><br><span class="line">    <span class="title function_">foo2</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">a</span>();</span><br><span class="line"><span class="comment">// undefined, undefined</span></span><br><span class="line">a.<span class="title function_">call</span>(<span class="string">&#x27;nico&#x27;</span>);</span><br><span class="line"><span class="comment">// nico, undefined</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> b = &#123;</span><br><span class="line">    <span class="attr">foo3</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>),</span><br><span class="line">    <span class="attr">foo4</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>); &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">b.<span class="title function_">foo3</span>();</span><br><span class="line"><span class="comment">// Window &#123;...&#125;</span></span><br><span class="line">b.<span class="title function_">foo4</span>();</span><br><span class="line"><span class="comment">// &#123; foo3: f, foo4, f&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> c = <span class="keyword">new</span> <span class="keyword">class</span> &#123;</span><br><span class="line">    foo5 () &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line">c.<span class="title function_">foo5</span>();</span><br><span class="line"><span class="comment">// &#123; &#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>参考资料</strong></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/this">this - JavaScript | MDN</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Arrow_functions">箭头函数 - JavaScript | MDN</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/19636194">如何理解 JavaScript 中的 this 关键字？ - 知乎</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2018-06-25-IDEA%E4%B8%AD%E5%AF%B9%E4%BD%BF%E7%94%A8Maven%E7%9A%84%E5%B7%A5%E7%A8%8B%E6%89%93%E5%8C%85.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018-06-25-IDEA%E4%B8%AD%E5%AF%B9%E4%BD%BF%E7%94%A8Maven%E7%9A%84%E5%B7%A5%E7%A8%8B%E6%89%93%E5%8C%85.html" class="post-title-link" itemprop="url">IDEA中对使用Maven的工程打包</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-06-25 06:50:43" itemprop="dateCreated datePublished" datetime="2018-06-25T06:50:43+08:00">2018-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-07-01 17:34:01" itemprop="dateModified" datetime="2021-07-01T17:34:01+08:00">2021-07-01</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>274</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

            <div class="post-description">只是记录一下遇到的坑；以后还是要按照 Maven 的规范进行打包</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>如果 <strong>工程的 META-INF 信息没有在工程的根目录下生成</strong> ，则直接使用 IDEA 打包 jar 文件时，会从 Maven 中获取配置信息；</p>
<p>如果 <strong>此时</strong> <code>pom.xml</code> <strong>中也没有完整的打包配置</strong>，则会读取默认的信息。</p>
<p>此时，打包出的 jar 文件的 META-INF 不包括启动类的名称，无法直接运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$java</span> -jar Nico.jar</span><br><span class="line">Nico.jar中没有主清单属性</span><br></pre></td></tr></table></figure>

<h1 id="Spring-Boot应用打包逻辑"><a href="#Spring-Boot应用打包逻辑" class="headerlink" title="Spring Boot应用打包逻辑"></a>Spring Boot应用打包逻辑</h1><p><a target="_blank" rel="noopener" href="https://incoder.org/2019/06/23/springboot1/#Spring-%E6%89%93%E5%8C%85">SpringBoot（一） 初识 | BladeCode</a><br><a target="_blank" rel="noopener" href="https://incoder.org/2019/07/05/springboot2/">SpringBoot（二） 启动分析JarLauncher | BladeCode</a><br><a target="_blank" rel="noopener" href="https://incoder.org/2020/02/02/springboot5/">SpringBoot（五）多环境配置 | BladeCode</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2018-06-14-Java%E5%86%85%E9%83%A8%E7%B1%BB%E7%9A%84NoClassDefFoundError.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018-06-14-Java%E5%86%85%E9%83%A8%E7%B1%BB%E7%9A%84NoClassDefFoundError.html" class="post-title-link" itemprop="url">Java同名内部类的 NoClassDefFoundError</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-06-14 12:50:51" itemprop="dateCreated datePublished" datetime="2018-06-14T12:50:51+08:00">2018-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-07-01 13:55:48" itemprop="dateModified" datetime="2021-07-01T13:55:48+08:00">2021-07-01</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>464</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

            <div class="post-description">Java 类的命名问题</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Windows 不区分文件名的大小写，因此你无法在同一个包中创建两个除大小写外类名完全相同的 Java 文件，但是内部类可以。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Fuck</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FuckYou</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Fuckyou</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Fuck</span>.FuckYou();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而且这段代码可以通过编译，只有在运行时才会抛出异常:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: Fuck$FuckYou (wrong name: Fuck$Fuckyou)</span><br></pre></td></tr></table></figure>

<p>当然，正常人不会去写这样的代码，但是用一些生成工具（例如antlr）生成代码时，就有可能出现内部类类名撞车的风险。这个时候，你需要仔细读异常信息：一个类是 <code>Fuck$FuckYou</code> 而另一个是 <code>Fuck$Fuckyou</code> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hahahaha123567.github.io/2018-05-23-Spring%E5%85%A5%E9%97%A8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hahahaha123567">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahahaha123567">
      <meta itemprop="description" content="niconiconi">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | hahahaha123567">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018-05-23-Spring%E5%85%A5%E9%97%A8.html" class="post-title-link" itemprop="url">Spring入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-05-23 23:45:26" itemprop="dateCreated datePublished" datetime="2018-05-23T23:45:26+08:00">2018-05-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-08-12 22:00:04" itemprop="dateModified" datetime="2018-08-12T22:00:04+08:00">2018-08-12</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

            <div class="post-description">Spring基础，几种配置方式</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>添加 maven 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="Ioc容器"><a href="#Ioc容器" class="headerlink" title="Ioc容器"></a>Ioc容器</h1><p>Spring 的 <strong>ApplicationContext</strong> 容器</p>
<p>最常被使用的 <strong>ApplicationContext</strong> 接口实现：</p>
<ul>
<li><strong>FileSystemXmlApplicationContext</strong>：该容器从 XML 文件中加载已被定义的 bean。在这里，你需要提供给构造器 XML 文件的完整路径</li>
<li><strong>ClassPathXmlApplicationContext</strong>：该容器从 XML 文件中加载已被定义的 bean。在这里，你不需要提供 XML 文件的完整路径，只需正确配置 CLASSPATH 环境变量即可，因为，容器会从 CLASSPATH 中搜索 bean 配置文件。</li>
<li><strong>WebXmlApplicationContext</strong>：该容器会在一个 web 应用程序的范围内加载在 XML 文件中已被定义的 bean。</li>
</ul>
<h1 id="Bean"><a href="#Bean" class="headerlink" title="Bean"></a>Bean</h1><h3 id="Bean的属性"><a href="#Bean的属性" class="headerlink" title="Bean的属性"></a>Bean的属性</h3><table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>class</td>
<td>这个属性是强制性的，并且指定用来创建 bean 的 bean 类。</td>
</tr>
<tr>
<td>name</td>
<td>这个属性指定唯一的 bean 标识符。在基于 XML 的配置元数据中，你可以使用 ID 和&#x2F;或 name 属性来指定 bean 标识符。</td>
</tr>
<tr>
<td>scope</td>
<td>singleton &#x2F; prototype</td>
</tr>
<tr>
<td>constructor-arg</td>
<td>注入依赖关系</td>
</tr>
<tr>
<td>properties</td>
<td>注入依赖关系</td>
</tr>
<tr>
<td>autowiring mode</td>
<td>byType &#x2F; byName</td>
</tr>
<tr>
<td>lazy-initialization mode</td>
<td>延迟初始化的 bean 告诉 IoC 容器在它第一次被请求时，而不是在启动时去创建一个 bean 实例。</td>
</tr>
<tr>
<td>initialization 方法</td>
<td>在 bean 的所有必需的属性被容器设置之后，调用回调方法</td>
</tr>
<tr>
<td>destruction 方法</td>
<td>当包含该 bean 的容器被销毁时，使用回调方法</td>
</tr>
</tbody></table>
<h3 id="BeanPostProcessor"><a href="#BeanPostProcessor" class="headerlink" title="BeanPostProcessor"></a>BeanPostProcessor</h3><p>实现 BeanPostProcessor 接口</p>
<p>调用顺序：</p>
<ol>
<li>BeanPostProcessor.postProcessBeforeInitialization</li>
<li>init-method</li>
<li>BeanPostProcessor.postProcessAfterInitialization</li>
</ol>
<h1 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h1><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><p>强制</p>
<h3 id="setter函数"><a href="#setter函数" class="headerlink" title="setter函数"></a>setter函数</h3><p>非强制</p>
<h1 id="配置方法：注解"><a href="#配置方法：注解" class="headerlink" title="配置方法：注解"></a>配置方法：注解</h1><p>xml 文件中添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Required"><a href="#Required" class="headerlink" title="@Required"></a>@Required</h3><ul>
<li>修饰setter方法<br>表示该属性必须设置</li>
</ul>
<h3 id="Autowired"><a href="#Autowired" class="headerlink" title="@Autowired"></a>@Autowired</h3><ul>
<li><p>修饰setter方法</p>
<p>执行 byType 自动连接</p>
</li>
<li><p>修饰属性</p>
<p>省略该属性的setter函数，执行 byType 自动连接</p>
</li>
<li><p>修饰构造函数</p>
<p>执行 constructor 自动连接</p>
</li>
</ul>
<p>默认 @Autowired 包括 @Required ，可以使用 @Autowired (required &#x3D; false) 取消</p>
<h3 id="Qualifier"><a href="#Qualifier" class="headerlink" title="@Qualifier"></a>@Qualifier</h3><ul>
<li><p>修饰属性</p>
<p>在有多个相同类型的 Bean 的情况下，指定装配 id 的那个</p>
</li>
</ul>
<h3 id="PostConstruct-PreDestroy"><a href="#PostConstruct-PreDestroy" class="headerlink" title="@PostConstruct @PreDestroy"></a>@PostConstruct @PreDestroy</h3><ul>
<li><p>修饰方法</p>
<p>声明 <strong>init-method</strong> 和 <strong>destroy-method</strong> 方法</p>
</li>
</ul>
<h1 id="配置方法：Java"><a href="#配置方法：Java" class="headerlink" title="配置方法：Java"></a>配置方法：Java</h1><h3 id="Configuration"><a href="#Configuration" class="headerlink" title="@Configuration"></a>@Configuration</h3><ul>
<li><p>修饰类</p>
<p>声明该类是配置类</p>
</li>
</ul>
<h3 id="Bean-1"><a href="#Bean-1" class="headerlink" title="@Bean"></a>@Bean</h3><ul>
<li><p>修饰方法</p>
<p>表明该方法返回一个Bean</p>
</li>
</ul>
<p>Java 配置方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldConfig</span> &#123;</span><br><span class="line">   <span class="meta">@Bean</span> <span class="comment">// 方法名就是Bean的id</span></span><br><span class="line">   <span class="keyword">public</span> HelloWorld <span class="title function_">helloWorld</span><span class="params">()</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HelloWorld</span>();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>等价于对应的 xml 配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;helloWorld&quot;</span> <span class="attr">class</span>=<span class="string">&quot;HelloWorld&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>进行调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">   <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>();</span><br><span class="line">   ctx.register(AppConfig.class, OtherConfig.class);</span><br><span class="line">   ctx.refresh();</span><br><span class="line">   <span class="type">MyService</span> <span class="variable">myService</span> <span class="operator">=</span> ctx.getBean(MyService.class);</span><br><span class="line">   myService.doStuff();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Import"><a href="#Import" class="headerlink" title="@Import"></a>@Import</h3><ul>
<li><p>修饰配置类</p>
<p>导入所需的其他Bean的配置类</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConfigA.java</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigA</span> &#123;</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> A <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">A</span>(); </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ConfigB.java</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(ConfigA.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigB</span> &#123;</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> B <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">A</span>(); </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// App.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">   <span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> </span><br><span class="line">   <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(ConfigB.class);</span><br><span class="line">   <span class="comment">// now both beans A and B will be available...</span></span><br><span class="line">   <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> ctx.getBean(A.class);</span><br><span class="line">   <span class="type">B</span> <span class="variable">b</span> <span class="operator">=</span> ctx.getBean(B.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Scope"><a href="#Scope" class="headerlink" title="@Scope"></a>@Scope</h3><ul>
<li><p>修饰返回Bean的方法</p>
<p>和 xml 中作用相同</p>
</li>
</ul>
<h1 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h1><p>通过 <strong>ApplicationEvent</strong> 类和 <strong>ApplicationListener</strong> 接口来提供在 <strong>ApplicationContext</strong> 中处理事件。 </p>
<table>
<thead>
<tr>
<th>序号</th>
<th>Spring 内置事件 &amp; 描述</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td><strong>ContextRefreshedEvent</strong><em>ApplicationContext</em> 被初始化或刷新时，该事件被发布。这也可以在 <em>ConfigurableApplicationContext</em>接口中使用 refresh() 方法来发生。</td>
</tr>
<tr>
<td>2</td>
<td><strong>ContextStartedEvent</strong>当使用 <em>ConfigurableApplicationContext</em> 接口中的 start() 方法启动 <em>ApplicationContext</em> 时，该事件被发布。你可以调查你的数据库，或者你可以在接受到这个事件后重启任何停止的应用程序。</td>
</tr>
<tr>
<td>3</td>
<td><strong>ContextStoppedEvent</strong>当使用 <em>ConfigurableApplicationContext</em> 接口中的 stop() 方法停止 <em>ApplicationContext</em> 时，发布这个事件。你可以在接受到这个事件后做必要的清理的工作。</td>
</tr>
<tr>
<td>4</td>
<td><strong>ContextClosedEvent</strong>当使用 <em>ConfigurableApplicationContext</em> 接口中的 close() 方法关闭 <em>ApplicationContext</em> 时，该事件被发布。一个已关闭的上下文到达生命周期末端；它不能被刷新或重启。</td>
</tr>
<tr>
<td>5</td>
<td><strong>RequestHandledEvent</strong>这是一个 web-specific 事件，告诉所有 bean HTTP 请求已经被服务。</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MainApp.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainApp</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> </span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;Beans.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">      context.start();</span><br><span class="line"></span><br><span class="line">      <span class="type">HelloWorld</span> <span class="variable">obj</span> <span class="operator">=</span> (HelloWorld) context.getBean(<span class="string">&quot;helloWorld&quot;</span>);</span><br><span class="line">      obj.getMessage();</span><br><span class="line"></span><br><span class="line">      context.stop();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// CStartEventHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CStartEventHandler</span> </span><br><span class="line">   <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ContextStartedEvent&gt;&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ContextStartedEvent event)</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;ContextStartedEvent Received&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>参考资料</p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/core.html">Core Technologies</a> 这是官网的官方文档，找了好久才找到ORZ：<a target="_blank" rel="noopener" href="https://spring.io/">https://spring.io</a> -&gt; projects -&gt; spring framework -&gt; features -&gt; core technologies，看来官方已经默认没有noob会从官网开始学习spring了</p>
<p><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/spring">Spring教程_极客学院Wiki</a></p>
<p><a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/spring/index.htm">Spring Tutorial</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2017 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hahahaha123567</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">162k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:27</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  





  





</body>
</html>
